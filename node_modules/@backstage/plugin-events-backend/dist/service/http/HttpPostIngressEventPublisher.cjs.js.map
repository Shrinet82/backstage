{"version":3,"file":"HttpPostIngressEventPublisher.cjs.js","sources":["../../../src/service/http/HttpPostIngressEventPublisher.ts"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { LoggerService } from '@backstage/backend-plugin-api';\nimport { Config } from '@backstage/config';\nimport {\n  EventsService,\n  HttpBodyParser,\n  HttpPostIngressOptions,\n  RequestValidator,\n} from '@backstage/plugin-events-node';\nimport contentType from 'content-type';\nimport express from 'express';\nimport Router from 'express-promise-router';\nimport { defaultHttpBodyParsers } from './body-parser';\nimport { RequestValidationContextImpl } from './validation';\nimport { UnsupportedMediaTypeError } from './errors';\n/**\n * Publishes events received from their origin (e.g., webhook events from an SCM system)\n * via HTTP POST endpoint and passes the request body as event payload to the registered subscribers.\n *\n * @public\n */\n// TODO(pjungermann): add prom metrics? (see plugins/catalog-backend/src/util/metrics.ts, etc.)\nexport class HttpPostIngressEventPublisher {\n  static fromConfig(env: {\n    config: Config;\n    events: EventsService;\n    ingresses?: { [topic: string]: Omit<HttpPostIngressOptions, 'topic'> };\n    bodyParsers?: { [contentType: string]: HttpBodyParser };\n    logger: LoggerService;\n  }): HttpPostIngressEventPublisher {\n    const topics =\n      env.config.getOptionalStringArray('events.http.topics') ?? [];\n\n    const ingresses = env.ingresses ?? {};\n    topics.forEach(topic => {\n      // don't overwrite topic settings\n      // (e.g., added at the config as well as argument)\n      if (!ingresses[topic]) {\n        ingresses[topic] = {};\n      }\n    });\n\n    const parsers = { ...defaultHttpBodyParsers, ...env.bodyParsers };\n\n    return new HttpPostIngressEventPublisher(\n      env.events,\n      env.logger,\n      ingresses,\n      parsers,\n    );\n  }\n\n  private readonly events: EventsService;\n  private readonly logger: LoggerService;\n  private readonly ingresses: {\n    [topic: string]: Omit<HttpPostIngressOptions, 'topic'>;\n  };\n  private readonly bodyParsers: {\n    [contentType: string]: HttpBodyParser;\n  };\n\n  private constructor(\n    events: EventsService,\n    logger: LoggerService,\n    ingresses: {\n      [topic: string]: Omit<HttpPostIngressOptions, 'topic'>;\n    },\n    bodyParsers: {\n      [contentType: string]: HttpBodyParser;\n    },\n  ) {\n    this.events = events;\n    this.logger = logger;\n    this.ingresses = ingresses;\n    this.bodyParsers = bodyParsers;\n  }\n\n  bind(router: express.Router): void {\n    router.use('/http', this.createRouter(this.ingresses));\n  }\n\n  private createRouter(ingresses: {\n    [topic: string]: Omit<HttpPostIngressOptions, 'topic'>;\n  }): express.Router {\n    const router = Router();\n    router.use(express.raw({ type: '*/*', limit: '5mb' }));\n\n    Object.keys(ingresses).forEach(topic =>\n      this.addRouteForTopic(router, topic, ingresses[topic].validator),\n    );\n\n    return router;\n  }\n\n  private addRouteForTopic(\n    router: express.Router,\n    topic: string,\n    validator?: RequestValidator,\n  ): void {\n    const path = `/${topic}`;\n    const logger = this.logger;\n\n    router.post(path, async (request, response) => {\n      const requestContentType = contentType.parse(request);\n      const bodyParser = this.bodyParsers[requestContentType.type ?? ''];\n\n      if (!bodyParser) {\n        throw new UnsupportedMediaTypeError(requestContentType.type);\n      }\n\n      const { bodyParsed, bodyBuffer, encoding } = await bodyParser(\n        request,\n        requestContentType,\n        topic,\n      );\n\n      if (validator) {\n        const requestDetails = {\n          body: bodyParsed,\n          headers: request.headers,\n          raw: {\n            body: bodyBuffer,\n            encoding: encoding as BufferEncoding,\n          },\n        };\n\n        const context = new RequestValidationContextImpl();\n        await validator(requestDetails, context);\n\n        if (context.wasRejected()) {\n          response\n            .status(context.rejectionDetails!.status)\n            .json(context.rejectionDetails!.payload);\n          return;\n        }\n      }\n\n      await this.events.publish({\n        topic,\n        eventPayload: bodyParsed,\n        metadata: request.headers,\n      });\n\n      response.status(202).json({ status: 'accepted' });\n    });\n\n    // TODO(pjungermann): We don't really know the externally defined path prefix here,\n    //  however it is more useful for users to have it. Is there a better way?\n    logger.info(`Registered /api/events/http${path} to receive events`);\n  }\n}\n"],"names":["defaultHttpBodyParsers","Router","express","contentType","UnsupportedMediaTypeError","RequestValidationContextImpl"],"mappings":"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"}