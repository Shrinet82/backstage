{"version":3,"file":"MemoryEventBusStore.cjs.js","sources":["../../../src/service/hub/MemoryEventBusStore.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { EventParams } from '@backstage/plugin-events-node';\nimport { EventBusStore } from './types';\nimport { NotFoundError } from '@backstage/errors';\nimport {\n  BackstageCredentials,\n  BackstageServicePrincipal,\n} from '@backstage/backend-plugin-api';\n\nconst MAX_BATCH_SIZE = 10;\nconst MAX_EVENTS_DEFAULT = 1_000;\n\nexport class MemoryEventBusStore implements EventBusStore {\n  #maxEvents: number;\n  #events = new Array<\n    EventParams & { seq: number; notifiedSubscribers: Set<string> }\n  >();\n  #subscribers = new Map<\n    string,\n    { id: string; seq: number; topics: Set<string> }\n  >();\n  #listeners = new Set<{\n    topics: Set<string>;\n    resolve(result: { topic: string }): void;\n  }>();\n\n  constructor(options: { maxEvents?: number } = {}) {\n    this.#maxEvents = options.maxEvents ?? MAX_EVENTS_DEFAULT;\n  }\n\n  async publish(options: {\n    event: EventParams;\n    notifiedSubscribers: string[];\n    credentials: BackstageCredentials<BackstageServicePrincipal>;\n  }): Promise<{ eventId: string } | undefined> {\n    const topic = options.event.topic;\n    const notifiedSubscribers = new Set(options.notifiedSubscribers);\n\n    let hasOtherSubscribers = false;\n    for (const sub of this.#subscribers.values()) {\n      if (sub.topics.has(topic) && !notifiedSubscribers.has(sub.id)) {\n        hasOtherSubscribers = true;\n        break;\n      }\n    }\n    if (!hasOtherSubscribers) {\n      return undefined;\n    }\n\n    const nextSeq = this.#getMaxSeq() + 1;\n    this.#events.push({ ...options.event, notifiedSubscribers, seq: nextSeq });\n\n    for (const listener of this.#listeners) {\n      if (listener.topics.has(topic)) {\n        listener.resolve({ topic });\n        this.#listeners.delete(listener);\n      }\n    }\n\n    // Trim old events\n    if (this.#events.length > this.#maxEvents) {\n      this.#events.shift();\n    }\n\n    return { eventId: String(nextSeq) };\n  }\n\n  #getMaxSeq() {\n    return this.#events[this.#events.length - 1]?.seq ?? 0;\n  }\n\n  async upsertSubscription(id: string, topics: string[]): Promise<void> {\n    const existing = this.#subscribers.get(id);\n    if (existing) {\n      existing.topics = new Set(topics);\n      return;\n    }\n    const sub = {\n      id: id,\n      seq: this.#getMaxSeq(),\n      topics: new Set(topics),\n    };\n    this.#subscribers.set(id, sub);\n  }\n\n  async readSubscription(id: string): Promise<{ events: EventParams[] }> {\n    const sub = this.#subscribers.get(id);\n    if (!sub) {\n      throw new NotFoundError(`Subscription not found`);\n    }\n    const events = this.#events\n      .filter(\n        event =>\n          event.seq > sub.seq &&\n          sub.topics.has(event.topic) &&\n          !event.notifiedSubscribers.has(id),\n      )\n      .slice(0, MAX_BATCH_SIZE);\n\n    sub.seq = events[events.length - 1]?.seq ?? sub.seq;\n\n    return {\n      events: events.map(({ topic, eventPayload }) => ({\n        topic,\n        eventPayload,\n      })),\n    };\n  }\n\n  async setupListener(\n    subscriptionId: string,\n    options: {\n      signal: AbortSignal;\n    },\n  ): Promise<{ waitForUpdate(): Promise<{ topic: string }> }> {\n    return {\n      waitForUpdate: async () => {\n        options.signal.throwIfAborted();\n\n        const sub = this.#subscribers.get(subscriptionId);\n        if (!sub) {\n          throw new NotFoundError(`Subscription not found`);\n        }\n\n        return new Promise<{ topic: string }>((resolve, reject) => {\n          const listener = {\n            topics: sub.topics,\n            resolve(result: { topic: string }) {\n              resolve(result);\n              cleanup();\n            },\n          };\n          this.#listeners.add(listener);\n\n          const onAbort = () => {\n            this.#listeners.delete(listener);\n            reject(options.signal.reason);\n            cleanup();\n          };\n\n          function cleanup() {\n            options.signal.removeEventListener('abort', onAbort);\n          }\n\n          options.signal.addEventListener('abort', onAbort);\n        });\n      },\n    };\n  }\n}\n"],"names":["NotFoundError"],"mappings":"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"}