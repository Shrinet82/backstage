{"version":3,"file":"GithubMultiOrgReaderProcessor.cjs.js","sources":["../../src/processors/GithubMultiOrgReaderProcessor.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  DEFAULT_NAMESPACE,\n  Entity,\n  isGroupEntity,\n  stringifyEntityRef,\n} from '@backstage/catalog-model';\nimport { Config } from '@backstage/config';\nimport {\n  DefaultGithubCredentialsProvider,\n  GithubAppCredentialsMux,\n  GithubCredentialsProvider,\n  GithubIntegrationConfig,\n  ScmIntegrationRegistry,\n  ScmIntegrations,\n} from '@backstage/integration';\nimport {\n  CatalogProcessor,\n  CatalogProcessorEmit,\n  LocationSpec,\n  processingResult,\n} from '@backstage/plugin-catalog-node';\nimport { graphql } from '@octokit/graphql';\nimport {\n  assignGroupsToUsers,\n  buildOrgHierarchy,\n  defaultOrganizationTeamTransformer,\n  defaultUserTransformer,\n  getOrganizationTeams,\n  getOrganizationUsers,\n  GithubMultiOrgConfig,\n  readGithubMultiOrgConfig,\n  TeamTransformer,\n  UserTransformer,\n} from '../lib';\nimport { areGroupEntities, areUserEntities } from '../lib/guards';\nimport { LoggerService } from '@backstage/backend-plugin-api';\n\n/**\n * Extracts teams and users out of a multiple GitHub orgs namespaced per org.\n *\n * Be aware that this processor may not be compatible with future org structures in the catalog.\n *\n * @public\n */\nexport class GithubMultiOrgReaderProcessor implements CatalogProcessor {\n  private readonly integrations: ScmIntegrationRegistry;\n  private readonly orgs: GithubMultiOrgConfig;\n  private readonly logger: LoggerService;\n  private readonly githubCredentialsProvider: GithubCredentialsProvider;\n\n  static fromConfig(\n    config: Config,\n    options: {\n      logger: LoggerService;\n      githubCredentialsProvider?: GithubCredentialsProvider;\n      userTransformer?: UserTransformer;\n      teamTransformer?: TeamTransformer;\n    },\n  ) {\n    const c = config.getOptionalConfig('catalog.processors.githubMultiOrg');\n    const integrations = ScmIntegrations.fromConfig(config);\n\n    return new GithubMultiOrgReaderProcessor({\n      ...options,\n      integrations,\n      orgs: c ? readGithubMultiOrgConfig(c) : [],\n    });\n  }\n\n  constructor(\n    private options: {\n      integrations: ScmIntegrationRegistry;\n      logger: LoggerService;\n      orgs: GithubMultiOrgConfig;\n      githubCredentialsProvider?: GithubCredentialsProvider;\n      userTransformer?: UserTransformer;\n      teamTransformer?: TeamTransformer;\n    },\n  ) {\n    this.integrations = options.integrations;\n    this.logger = options.logger;\n    this.orgs = options.orgs;\n    this.githubCredentialsProvider =\n      options.githubCredentialsProvider ||\n      DefaultGithubCredentialsProvider.fromIntegrations(this.integrations);\n  }\n  getProcessorName(): string {\n    return 'GithubMultiOrgReaderProcessor';\n  }\n\n  async readLocation(\n    location: LocationSpec,\n    _optional: boolean,\n    emit: CatalogProcessorEmit,\n  ): Promise<boolean> {\n    if (location.type !== 'github-multi-org') {\n      return false;\n    }\n\n    const gitHubConfig = this.integrations.github.byUrl(\n      location.target,\n    )?.config;\n    if (!gitHubConfig) {\n      throw new Error(\n        `There is no GitHub integration that matches ${location.target}. Please add a configuration entry for it under integrations.github`,\n      );\n    }\n\n    const allUsersMap = new Map();\n    const baseUrl = new URL(location.target).origin;\n\n    const orgsToProcess = this.orgs.length\n      ? this.orgs\n      : await this.getAllOrgs(gitHubConfig);\n\n    for (const orgConfig of orgsToProcess) {\n      try {\n        const { headers, type: tokenType } =\n          await this.githubCredentialsProvider.getCredentials({\n            url: `${baseUrl}/${orgConfig.name}`,\n          });\n        const client = graphql.defaults({\n          baseUrl: gitHubConfig.apiBaseUrl,\n          headers,\n        });\n\n        const startTimestamp = Date.now();\n        this.logger.info(\n          `Reading GitHub users and teams for org: ${orgConfig.name}`,\n        );\n        const { users } = await getOrganizationUsers(\n          client,\n          orgConfig.name,\n          tokenType,\n          async (githubUser, ctx): Promise<Entity | undefined> => {\n            const result = this.options.userTransformer\n              ? await this.options.userTransformer(githubUser, ctx)\n              : await defaultUserTransformer(githubUser, ctx);\n\n            if (result) {\n              result.metadata.namespace = orgConfig.userNamespace;\n            }\n\n            return result;\n          },\n        );\n\n        const { teams } = await getOrganizationTeams(\n          client,\n          orgConfig.name,\n          async (team, ctx): Promise<Entity | undefined> => {\n            const result = this.options.teamTransformer\n              ? await this.options.teamTransformer(team, ctx)\n              : await defaultOrganizationTeamTransformer(team, ctx);\n\n            if (result && isGroupEntity(result)) {\n              result.metadata.namespace = orgConfig.groupNamespace;\n              // Group `spec.members` inherits the namespace of it's group so need to explicitly specify refs here\n              result.spec.members = team.members.map(\n                user =>\n                  `${orgConfig.userNamespace ?? DEFAULT_NAMESPACE}/${\n                    user.login\n                  }`,\n              );\n            }\n\n            return result;\n          },\n        );\n\n        const duration = ((Date.now() - startTimestamp) / 1000).toFixed(1);\n        this.logger.debug(\n          `Read ${users.length} GitHub users and ${teams.length} GitHub teams from ${orgConfig.name} in ${duration} seconds`,\n        );\n\n        // Grab current users from `allUsersMap` if they already exist in our\n        // pending users so we can append to their group membership relations\n        const pendingUsers = users.map(u => {\n          const userRef = stringifyEntityRef(u);\n          if (!allUsersMap.has(userRef)) {\n            allUsersMap.set(userRef, u);\n          }\n\n          return allUsersMap.get(userRef);\n        });\n\n        if (areGroupEntities(teams)) {\n          buildOrgHierarchy(teams);\n          if (areUserEntities(pendingUsers)) {\n            assignGroupsToUsers(pendingUsers, teams);\n          }\n        }\n\n        for (const team of teams) {\n          emit(processingResult.entity(location, team));\n        }\n      } catch (e) {\n        this.logger.error(\n          `Failed to read GitHub org data for ${orgConfig.name}: ${e}`,\n        );\n      }\n    }\n\n    // Emit all users at the end after all orgs have been processed\n    // so all memberships across org groups are accounted for\n    const allUsers = Array.from(allUsersMap.values());\n    for (const user of allUsers) {\n      emit(processingResult.entity(location, user));\n    }\n\n    return true;\n  }\n\n  // Note: Does not support usage of PATs\n  private async getAllOrgs(\n    gitHubConfig: GithubIntegrationConfig,\n  ): Promise<GithubMultiOrgConfig> {\n    const githubAppMux = new GithubAppCredentialsMux(gitHubConfig);\n    const installs = await githubAppMux.getAllInstallations();\n\n    return installs\n      .map(install =>\n        install.target_type === 'Organization' &&\n        install.account &&\n        'login' in install.account &&\n        install.account.login\n          ? {\n              name: install.account.login,\n              groupNamespace: install.account.login.toLowerCase(),\n            }\n          : undefined,\n      )\n      .filter(Boolean) as GithubMultiOrgConfig;\n  }\n}\n"],"names":["DefaultGithubCredentialsProvider","config","ScmIntegrations","readGithubMultiOrgConfig","graphql","getOrganizationUsers","defaultUserTransformer","getOrganizationTeams","defaultOrganizationTeamTransformer","isGroupEntity","DEFAULT_NAMESPACE","stringifyEntityRef","areGroupEntities","buildOrgHierarchy","areUserEntities","assignGroupsToUsers","processingResult","GithubAppCredentialsMux"],"mappings":"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"}