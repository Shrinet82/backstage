{"version":3,"file":"GithubDiscoveryProcessor.cjs.js","sources":["../../src/processors/GithubDiscoveryProcessor.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Config } from '@backstage/config';\nimport {\n  DefaultGithubCredentialsProvider,\n  GithubCredentialsProvider,\n  ScmIntegrationRegistry,\n  ScmIntegrations,\n} from '@backstage/integration';\nimport {\n  CatalogProcessor,\n  CatalogProcessorEmit,\n  LocationSpec,\n  processingResult,\n} from '@backstage/plugin-catalog-node';\nimport { graphql } from '@octokit/graphql';\nimport { getOrganizationRepositories } from '../lib';\nimport { LoggerService } from '@backstage/backend-plugin-api';\n\n/**\n * Extracts repositories out of a GitHub org.\n *\n * The following will create locations for all projects which have a catalog-info.yaml\n * on the default branch. The first is shorthand for the second.\n *\n *    target: \"https://github.com/backstage\"\n *    or\n *    target: https://github.com/backstage/*\\/blob/-/catalog-info.yaml\n *\n * You may also explicitly specify the source branch:\n *\n *    target: https://github.com/backstage/*\\/blob/main/catalog-info.yaml\n *\n * @public\n */\nexport class GithubDiscoveryProcessor implements CatalogProcessor {\n  private readonly integrations: ScmIntegrationRegistry;\n  private readonly logger: LoggerService;\n  private readonly githubCredentialsProvider: GithubCredentialsProvider;\n\n  static fromConfig(\n    config: Config,\n    options: {\n      logger: LoggerService;\n      githubCredentialsProvider?: GithubCredentialsProvider;\n    },\n  ) {\n    const integrations = ScmIntegrations.fromConfig(config);\n\n    return new GithubDiscoveryProcessor({\n      ...options,\n      integrations,\n    });\n  }\n\n  constructor(options: {\n    integrations: ScmIntegrationRegistry;\n    logger: LoggerService;\n    githubCredentialsProvider?: GithubCredentialsProvider;\n  }) {\n    this.integrations = options.integrations;\n    this.logger = options.logger;\n    this.githubCredentialsProvider =\n      options.githubCredentialsProvider ||\n      DefaultGithubCredentialsProvider.fromIntegrations(this.integrations);\n  }\n  getProcessorName(): string {\n    return 'GithubDiscoveryProcessor';\n  }\n\n  async readLocation(\n    location: LocationSpec,\n    _optional: boolean,\n    emit: CatalogProcessorEmit,\n  ): Promise<boolean> {\n    if (location.type !== 'github-discovery') {\n      return false;\n    }\n\n    const gitHubConfig = this.integrations.github.byUrl(\n      location.target,\n    )?.config;\n    if (!gitHubConfig) {\n      throw new Error(\n        `There is no GitHub integration that matches ${location.target}. Please add a configuration entry for it under integrations.github`,\n      );\n    }\n\n    const { org, repoSearchPath, catalogPath, branch, host } = parseUrl(\n      location.target,\n    );\n\n    // Building the org url here so that the github creds provider doesn't need to know\n    // about how to handle the wild card which is special for this processor.\n    const orgUrl = `https://${host}/${org}`;\n\n    const { headers } = await this.githubCredentialsProvider.getCredentials({\n      url: orgUrl,\n    });\n\n    const client = graphql.defaults({\n      baseUrl: gitHubConfig.apiBaseUrl,\n      headers,\n    });\n\n    // Read out all of the raw data\n    const startTimestamp = Date.now();\n    this.logger.info(`Reading GitHub repositories from ${location.target}`);\n\n    const { repositories } = await getOrganizationRepositories(\n      client,\n      org,\n      catalogPath,\n    );\n    const matching = repositories.filter(\n      r => !r.isArchived && repoSearchPath.test(r.name),\n    );\n\n    const duration = ((Date.now() - startTimestamp) / 1000).toFixed(1);\n    this.logger.debug(\n      `Read ${repositories.length} GitHub repositories (${matching.length} matching the pattern) in ${duration} seconds`,\n    );\n\n    for (const repository of matching) {\n      const branchName =\n        branch === '-' ? repository.defaultBranchRef?.name : branch;\n\n      if (!branchName) {\n        this.logger.info(\n          `the repository ${repository.url} does not have a default branch, skipping`,\n        );\n        continue;\n      }\n\n      const path = `/blob/${branchName}${catalogPath}`;\n\n      emit(\n        processingResult.location({\n          type: 'url',\n          target: `${repository.url}${path}`,\n          // Not all locations may actually exist, since the user defined them as a wildcard pattern.\n          // Thus, we emit them as optional and let the downstream processor find them while not outputting\n          // an error if it couldn't.\n          presence: 'optional',\n        }),\n      );\n    }\n\n    return true;\n  }\n}\n\n/*\n * Helpers\n */\n\nexport function parseUrl(urlString: string): {\n  org: string;\n  repoSearchPath: RegExp;\n  catalogPath: string;\n  branch: string;\n  host: string;\n} {\n  const url = new URL(urlString);\n  const path = url.pathname.slice(1).split('/');\n\n  // /backstage/techdocs-*/blob/master/catalog-info.yaml\n  // can also be\n  // /backstage\n  if (path.length > 2 && path[0].length && path[1].length) {\n    return {\n      org: decodeURIComponent(path[0]),\n      repoSearchPath: escapeRegExp(decodeURIComponent(path[1])),\n      branch: decodeURIComponent(path[3]),\n      catalogPath: `/${decodeURIComponent(path.slice(4).join('/'))}`,\n      host: url.host,\n    };\n  } else if (path.length === 1 && path[0].length) {\n    return {\n      org: decodeURIComponent(path[0]),\n      host: url.host,\n      repoSearchPath: escapeRegExp('*'),\n      catalogPath: '/catalog-info.yaml',\n      branch: '-',\n    };\n  }\n\n  throw new Error(`Failed to parse ${urlString}`);\n}\n\nexport function escapeRegExp(str: string): RegExp {\n  return new RegExp(`^${str.replace(/\\*/g, '.*')}$`);\n}\n"],"names":["ScmIntegrations","DefaultGithubCredentialsProvider","graphql","getOrganizationRepositories","processingResult"],"mappings":"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"}