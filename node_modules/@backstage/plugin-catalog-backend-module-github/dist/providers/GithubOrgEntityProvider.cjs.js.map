{"version":3,"file":"GithubOrgEntityProvider.cjs.js","sources":["../../src/providers/GithubOrgEntityProvider.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  LoggerService,\n  SchedulerServiceTaskRunner,\n} from '@backstage/backend-plugin-api';\nimport { Entity, isGroupEntity } from '@backstage/catalog-model';\nimport { Config } from '@backstage/config';\nimport {\n  DefaultGithubCredentialsProvider,\n  GithubCredentialsProvider,\n  GithubIntegrationConfig,\n  ScmIntegrations,\n  SingleInstanceGithubCredentialsProvider,\n} from '@backstage/integration';\nimport {\n  EntityProvider,\n  EntityProviderConnection,\n} from '@backstage/plugin-catalog-node';\nimport { EventParams, EventsService } from '@backstage/plugin-events-node';\nimport { graphql } from '@octokit/graphql';\nimport {\n  MembershipEvent,\n  OrganizationEvent,\n  OrganizationMemberAddedEvent,\n  OrganizationMemberRemovedEvent,\n  TeamEditedEvent,\n  TeamEvent,\n} from '@octokit/webhooks-types';\nimport * as uuid from 'uuid';\nimport {\n  defaultOrganizationTeamTransformer,\n  defaultUserTransformer,\n  TeamTransformer,\n  UserTransformer,\n} from '../lib/defaultTransformers';\nimport {\n  createAddEntitiesOperation,\n  createGraphqlClient,\n  createRemoveEntitiesOperation,\n  createReplaceEntitiesOperation,\n  DeferredEntitiesBuilder,\n  getOrganizationTeam,\n  getOrganizationTeams,\n  getOrganizationTeamsFromUsers,\n  getOrganizationUsers,\n  GithubTeam,\n} from '../lib/github';\nimport { areGroupEntities, areUserEntities } from '../lib/guards';\nimport { assignGroupsToUsers, buildOrgHierarchy } from '../lib/org';\nimport { parseGithubOrgUrl } from '../lib/util';\nimport { withLocations } from '../lib/withLocations';\n\nconst EVENT_TOPICS = [\n  'github.membership',\n  'github.organization',\n  'github.team',\n];\n\n/**\n * Options for {@link GithubOrgEntityProvider}.\n *\n * @public\n */\nexport interface GithubOrgEntityProviderOptions {\n  /**\n   * A unique, stable identifier for this provider.\n   *\n   * @example \"production\"\n   */\n  id: string;\n\n  /**\n   * The target that this provider should consume.\n   *\n   * @example \"https://github.com/backstage\"\n   */\n  orgUrl: string;\n\n  /**\n   * Passing the optional EventsService enables event-based delta updates.\n   */\n  events?: EventsService;\n\n  /**\n   * The refresh schedule to use.\n   *\n   * @defaultValue \"manual\"\n   * @remarks\n   *\n   * If you pass in 'manual', you are responsible for calling the `read` method\n   * manually at some interval.\n   *\n   * But more commonly you will pass in the result of\n   * {@link @backstage/backend-plugin-api#SchedulerService.createScheduledTaskRunner}\n   * to enable automatic scheduling of tasks.\n   */\n  schedule?: 'manual' | SchedulerServiceTaskRunner;\n\n  /**\n   * The logger to use.\n   */\n  logger: LoggerService;\n\n  /**\n   * Optionally supply a custom credentials provider, replacing the default one.\n   */\n  githubCredentialsProvider?: GithubCredentialsProvider;\n\n  /**\n   * Optionally include a user transformer for transforming from GitHub users to User Entities\n   */\n  userTransformer?: UserTransformer;\n\n  /**\n   * Optionally include a team transformer for transforming from GitHub teams to Group Entities\n   */\n  teamTransformer?: TeamTransformer;\n}\n\n/**\n * Ingests org data (users and groups) from GitHub.\n *\n * @public\n */\nexport class GithubOrgEntityProvider implements EntityProvider {\n  private readonly credentialsProvider: GithubCredentialsProvider;\n  private connection?: EntityProviderConnection;\n  private scheduleFn?: () => Promise<void>;\n\n  static fromConfig(config: Config, options: GithubOrgEntityProviderOptions) {\n    const integrations = ScmIntegrations.fromConfig(config);\n    const gitHubConfig = integrations.github.byUrl(options.orgUrl)?.config;\n\n    if (!gitHubConfig) {\n      throw new Error(\n        `There is no GitHub Org provider that matches ${options.orgUrl}. Please add a configuration for an integration.`,\n      );\n    }\n\n    const logger = options.logger.child({\n      target: options.orgUrl,\n    });\n\n    const provider = new GithubOrgEntityProvider({\n      id: options.id,\n      orgUrl: options.orgUrl,\n      logger,\n      gitHubConfig,\n      githubCredentialsProvider:\n        options.githubCredentialsProvider ||\n        DefaultGithubCredentialsProvider.fromIntegrations(integrations),\n      userTransformer: options.userTransformer,\n      teamTransformer: options.teamTransformer,\n      events: options.events,\n    });\n\n    provider.schedule(options.schedule);\n\n    return provider;\n  }\n\n  constructor(\n    private options: {\n      events?: EventsService;\n      id: string;\n      orgUrl: string;\n      gitHubConfig: GithubIntegrationConfig;\n      logger: LoggerService;\n      githubCredentialsProvider?: GithubCredentialsProvider;\n      userTransformer?: UserTransformer;\n      teamTransformer?: TeamTransformer;\n    },\n  ) {\n    this.credentialsProvider =\n      options.githubCredentialsProvider ||\n      SingleInstanceGithubCredentialsProvider.create(this.options.gitHubConfig);\n  }\n\n  /** {@inheritdoc @backstage/plugin-catalog-node#EntityProvider.getProviderName} */\n  getProviderName() {\n    return `GithubOrgEntityProvider:${this.options.id}`;\n  }\n\n  /** {@inheritdoc @backstage/plugin-catalog-node#EntityProvider.connect} */\n  async connect(connection: EntityProviderConnection) {\n    this.connection = connection;\n    await this.options.events?.subscribe({\n      id: this.getProviderName(),\n      topics: EVENT_TOPICS,\n      onEvent: params => this.onEvent(params),\n    });\n    await this.scheduleFn?.();\n  }\n\n  /**\n   * Runs one single complete ingestion. This is only necessary if you use\n   * manual scheduling.\n   */\n  async read(options?: { logger?: LoggerService }) {\n    if (!this.connection) {\n      throw new Error('Not initialized');\n    }\n\n    const logger = options?.logger ?? this.options.logger;\n    const { markReadComplete } = trackProgress(logger);\n\n    const { headers, type: tokenType } =\n      await this.credentialsProvider.getCredentials({\n        url: this.options.orgUrl,\n      });\n\n    const client = createGraphqlClient({\n      headers,\n      baseUrl: this.options.gitHubConfig.apiBaseUrl!,\n      logger,\n    });\n\n    const { org } = parseGithubOrgUrl(this.options.orgUrl);\n    const { users } = await getOrganizationUsers(\n      client,\n      org,\n      tokenType,\n      this.options.userTransformer,\n    );\n    const { teams } = await getOrganizationTeams(\n      client,\n      org,\n      this.options.teamTransformer,\n    );\n\n    if (areGroupEntities(teams)) {\n      buildOrgHierarchy(teams);\n      if (areUserEntities(users)) {\n        assignGroupsToUsers(users, teams);\n      }\n    }\n\n    const { markCommitComplete } = markReadComplete({ users, teams });\n\n    await this.connection.applyMutation({\n      type: 'full',\n      entities: [...users, ...teams].map(entity => ({\n        locationKey: `github-org-provider:${this.options.id}`,\n        entity: withLocations(\n          `https://${this.options.gitHubConfig.host}`,\n          org,\n          entity,\n        ),\n      })),\n    });\n\n    markCommitComplete();\n  }\n\n  private async onEvent(params: EventParams): Promise<void> {\n    const { logger } = this.options;\n    logger.debug(`Received event from ${params.topic}`);\n\n    const addEntitiesOperation = createAddEntitiesOperation(\n      this.options.id,\n      this.options.gitHubConfig.host,\n    );\n    const removeEntitiesOperation = createRemoveEntitiesOperation(\n      this.options.id,\n      this.options.gitHubConfig.host,\n    );\n\n    const replaceEntitiesOperation = createReplaceEntitiesOperation(\n      this.options.id,\n      this.options.gitHubConfig.host,\n    );\n\n    // handle change users in the org\n    // https://docs.github.com/en/developers/webhooks-and-events/webhooks/webhook-events-and-payloads#organization\n    if (params.topic.includes('organization')) {\n      const orgEvent = params.eventPayload as OrganizationEvent;\n\n      if (\n        orgEvent.action === 'member_added' ||\n        orgEvent.action === 'member_removed'\n      ) {\n        const createDeltaOperation =\n          orgEvent.action === 'member_added'\n            ? addEntitiesOperation\n            : removeEntitiesOperation;\n        await this.onMemberChangeInOrganization(orgEvent, createDeltaOperation);\n      }\n    }\n\n    // handle change teams in the org\n    // https://docs.github.com/en/developers/webhooks-and-events/webhooks/webhook-events-and-payloads#team\n    if (params.topic.includes('team')) {\n      const teamEvent = params.eventPayload as TeamEvent;\n      if (teamEvent.action === 'created' || teamEvent.action === 'deleted') {\n        const createDeltaOperation =\n          teamEvent.action === 'created'\n            ? addEntitiesOperation\n            : removeEntitiesOperation;\n        await this.onTeamChangeInOrganization(teamEvent, createDeltaOperation);\n      } else if (teamEvent.action === 'edited') {\n        await this.onTeamEditedInOrganization(\n          teamEvent,\n          replaceEntitiesOperation,\n        );\n      }\n    }\n\n    // handle change membership in the org\n    // https://docs.github.com/en/developers/webhooks-and-events/webhooks/webhook-events-and-payloads#membership\n    if (params.topic.includes('membership')) {\n      const membershipEvent = params.eventPayload as MembershipEvent;\n      this.onMembershipChangedInOrganization(\n        membershipEvent,\n        replaceEntitiesOperation,\n      );\n    }\n\n    return;\n  }\n\n  private async onTeamEditedInOrganization(\n    event: TeamEditedEvent,\n    createDeltaOperation: DeferredEntitiesBuilder,\n  ) {\n    if (!this.connection) {\n      throw new Error('Not initialized');\n    }\n\n    const teamSlug = event.team.slug;\n    const { headers, type: tokenType } =\n      await this.credentialsProvider.getCredentials({\n        url: this.options.orgUrl,\n      });\n    const client = graphql.defaults({\n      baseUrl: this.options.gitHubConfig.apiBaseUrl,\n      headers,\n    });\n\n    const { org } = parseGithubOrgUrl(this.options.orgUrl);\n    const { team } = await getOrganizationTeam(\n      client,\n      org,\n      teamSlug,\n      this.options.teamTransformer,\n    );\n\n    const { users } = await getOrganizationUsers(\n      client,\n      org,\n      tokenType,\n      this.options.userTransformer,\n    );\n\n    if (!isGroupEntity(team)) {\n      return;\n    }\n\n    const usersFromChangedGroup = team.spec.members || [];\n    const usersToRebuild = users.filter(u =>\n      usersFromChangedGroup.includes(u.metadata.name),\n    );\n\n    const { teams } = await getOrganizationTeamsFromUsers(\n      client,\n      org,\n      usersToRebuild.map(u => u.metadata.name),\n      this.options.teamTransformer,\n    );\n\n    if (areGroupEntities(teams)) {\n      buildOrgHierarchy(teams);\n      if (areUserEntities(usersToRebuild)) {\n        assignGroupsToUsers(usersToRebuild, teams);\n      }\n    }\n\n    const oldName = event.changes.name?.from || event.team.name;\n    const oldSlug = oldName.toLowerCase().replaceAll(/\\s/gi, '-');\n\n    const oldDescription =\n      event.changes.description?.from || event.team.description;\n    const oldDescriptionSlug = oldDescription\n      ?.toLowerCase()\n      .replaceAll(/\\s/gi, '-');\n\n    const { removed } = createDeltaOperation(org, [\n      {\n        ...team,\n        metadata: {\n          name: oldSlug,\n          description: oldDescriptionSlug,\n        },\n      },\n    ]);\n    const { added } = createDeltaOperation(org, [...usersToRebuild, ...teams]);\n    await this.connection.applyMutation({\n      type: 'delta',\n      removed,\n      added,\n    });\n  }\n\n  private async onMembershipChangedInOrganization(\n    event: MembershipEvent,\n    createDeltaOperation: DeferredEntitiesBuilder,\n  ) {\n    if (!this.connection) {\n      throw new Error('Not initialized');\n    }\n\n    // The docs are saying I will receive the slug for the removed event,\n    // but the types don't reflect that,\n    // so I will just check to be sure the slug is there\n    // https://docs.github.com/en/developers/webhooks-and-events/webhooks/webhook-events-and-payloads#membership\n    if (!('slug' in event.team)) {\n      return;\n    }\n\n    const teamSlug = event.team.slug;\n    const userLogin = event.member.login;\n    const { headers, type: tokenType } =\n      await this.credentialsProvider.getCredentials({\n        url: this.options.orgUrl,\n      });\n    const client = graphql.defaults({\n      baseUrl: this.options.gitHubConfig.apiBaseUrl,\n      headers,\n    });\n\n    const { org } = parseGithubOrgUrl(this.options.orgUrl);\n    const { team } = await getOrganizationTeam(\n      client,\n      org,\n      teamSlug,\n      this.options.teamTransformer,\n    );\n\n    const { users } = await getOrganizationUsers(\n      client,\n      org,\n      tokenType,\n      this.options.userTransformer,\n    );\n\n    const usersToRebuild = users.filter(u => u.metadata.name === userLogin);\n\n    const { teams } = await getOrganizationTeamsFromUsers(\n      client,\n      org,\n      [userLogin],\n      this.options.teamTransformer,\n    );\n\n    // we include group because the removed event need to update the old group too\n    if (!teams.some(t => t.metadata.name === team.metadata.name)) {\n      teams.push(team);\n    }\n\n    if (areGroupEntities(teams)) {\n      buildOrgHierarchy(teams);\n      if (areUserEntities(usersToRebuild)) {\n        assignGroupsToUsers(usersToRebuild, teams);\n      }\n    }\n\n    const { added, removed } = createDeltaOperation(org, [\n      ...usersToRebuild,\n      ...teams,\n    ]);\n    await this.connection.applyMutation({\n      type: 'delta',\n      removed,\n      added,\n    });\n  }\n\n  private async onTeamChangeInOrganization(\n    event: TeamEvent,\n    createDeltaOperation: DeferredEntitiesBuilder,\n  ) {\n    if (!this.connection) {\n      throw new Error('Not initialized');\n    }\n\n    const organizationTeamTransformer =\n      this.options.teamTransformer || defaultOrganizationTeamTransformer;\n    const { name, html_url: url, description, slug } = event.team;\n    const org = event.organization.login;\n    const { headers } = await this.credentialsProvider.getCredentials({\n      url: this.options.orgUrl,\n    });\n    const client = graphql.defaults({\n      baseUrl: this.options.gitHubConfig.apiBaseUrl,\n      headers,\n    });\n\n    const group = (await organizationTeamTransformer(\n      {\n        name,\n        slug,\n        editTeamUrl: `${url}/edit`,\n        combinedSlug: `${org}/${slug}`,\n        description: description || undefined,\n        parentTeam: event.team?.parent?.slug\n          ? ({ slug: event.team.parent.slug } as GithubTeam)\n          : undefined,\n        // entity will be removed\n        members: [],\n      },\n      {\n        org,\n        client,\n        query: '',\n      },\n    )) as Entity;\n\n    const { added, removed } = createDeltaOperation(org, [group]);\n\n    await this.connection.applyMutation({\n      type: 'delta',\n      removed,\n      added,\n    });\n  }\n\n  private async onMemberChangeInOrganization(\n    event: OrganizationMemberAddedEvent | OrganizationMemberRemovedEvent,\n    createDeltaOperation: DeferredEntitiesBuilder,\n  ) {\n    if (!this.connection) {\n      throw new Error('Not initialized');\n    }\n\n    const userTransformer =\n      this.options.userTransformer || defaultUserTransformer;\n    const { name, avatar_url: avatarUrl, email, login } = event.membership.user;\n    const org = event.organization.login;\n    const { headers } = await this.credentialsProvider.getCredentials({\n      url: this.options.orgUrl,\n    });\n    const client = graphql.defaults({\n      baseUrl: this.options.gitHubConfig.apiBaseUrl,\n      headers,\n    });\n\n    const user = (await userTransformer(\n      {\n        name,\n        avatarUrl,\n        login,\n        email: email || undefined,\n        // we don't have this information in the event, so the refresh will handle that for us\n        organizationVerifiedDomainEmails: [],\n      },\n      {\n        org,\n        client,\n        query: '',\n      },\n    )) as Entity;\n\n    const { added, removed } = createDeltaOperation(org, [user]);\n    await this.connection.applyMutation({\n      type: 'delta',\n      removed,\n      added,\n    });\n  }\n\n  private schedule(schedule: GithubOrgEntityProviderOptions['schedule']) {\n    if (!schedule || schedule === 'manual') {\n      return;\n    }\n\n    this.scheduleFn = async () => {\n      const id = `${this.getProviderName()}:refresh`;\n      await schedule.run({\n        id,\n        fn: async () => {\n          const logger = this.options.logger.child({\n            class: GithubOrgEntityProvider.prototype.constructor.name,\n            taskId: id,\n            taskInstanceId: uuid.v4(),\n          });\n\n          try {\n            await this.read({ logger });\n          } catch (error) {\n            logger.error(\n              `${this.getProviderName()} refresh failed, ${error}`,\n              error,\n            );\n          }\n        },\n      });\n    };\n  }\n}\n\n// Helps wrap the timing and logging behaviors\nfunction trackProgress(logger: LoggerService) {\n  let timestamp = Date.now();\n  let summary: string;\n\n  logger.info('Reading GitHub users and teams');\n\n  function markReadComplete(read: { users: unknown[]; teams: unknown[] }) {\n    summary = `${read.users.length} GitHub users and ${read.teams.length} GitHub teams`;\n    const readDuration = ((Date.now() - timestamp) / 1000).toFixed(1);\n    timestamp = Date.now();\n    logger.info(`Read ${summary} in ${readDuration} seconds. Committing...`);\n    return { markCommitComplete };\n  }\n\n  function markCommitComplete() {\n    const commitDuration = ((Date.now() - timestamp) / 1000).toFixed(1);\n    logger.info(`Committed ${summary} in ${commitDuration} seconds.`);\n  }\n\n  return { markReadComplete };\n}\n"],"names":["SingleInstanceGithubCredentialsProvider","ScmIntegrations","DefaultGithubCredentialsProvider","createGraphqlClient","org","parseGithubOrgUrl","getOrganizationUsers","getOrganizationTeams","areGroupEntities","buildOrgHierarchy","areUserEntities","assignGroupsToUsers","withLocations","createAddEntitiesOperation","createRemoveEntitiesOperation","createReplaceEntitiesOperation","graphql","getOrganizationTeam","isGroupEntity","getOrganizationTeamsFromUsers","defaultOrganizationTeamTransformer","defaultUserTransformer","uuid"],"mappings":"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"}