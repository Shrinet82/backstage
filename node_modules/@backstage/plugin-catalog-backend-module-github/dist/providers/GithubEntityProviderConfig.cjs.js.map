{"version":3,"file":"GithubEntityProviderConfig.cjs.js","sources":["../../src/providers/GithubEntityProviderConfig.ts"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  SchedulerServiceTaskScheduleDefinition,\n  readSchedulerServiceTaskScheduleDefinitionFromConfig,\n} from '@backstage/backend-plugin-api';\nimport { Config } from '@backstage/config';\n\nconst DEFAULT_CATALOG_PATH = '/catalog-info.yaml';\nconst DEFAULT_PROVIDER_ID = 'default';\n\nexport const DEFAULT_GITHUB_ENTITY_PROVIDER_CONFIG_SCHEDULE = {\n  frequency: {\n    hours: 3,\n  },\n  timeout: {\n    hours: 1,\n  },\n};\n\nexport type GithubEntityProviderConfig = {\n  id: string;\n  catalogPath: string;\n  organization?: string;\n  app?: number;\n  host: string;\n  filters: {\n    repository?: RegExp;\n    branch?: string;\n    topic?: GithubTopicFilters;\n    allowForks: boolean;\n    visibility?: string[];\n    allowArchived: boolean;\n  };\n  validateLocationsExist: boolean;\n  schedule?: SchedulerServiceTaskScheduleDefinition;\n  pageSizes?: {\n    repositories?: number;\n  };\n};\n\nexport type GithubTopicFilters = {\n  exclude?: string[];\n  include?: string[];\n};\n\nexport function readProviderConfigs(\n  config: Config,\n): GithubEntityProviderConfig[] {\n  const providersConfig = config.getOptionalConfig('catalog.providers.github');\n  if (!providersConfig) {\n    return [];\n  }\n\n  if (providersConfig.has('organization') || providersConfig.has('app')) {\n    // simple/single config variant\n    return [readProviderConfig(DEFAULT_PROVIDER_ID, providersConfig)];\n  }\n\n  return providersConfig.keys().map(id => {\n    const providerConfig = providersConfig.getConfig(id);\n\n    return readProviderConfig(id, providerConfig);\n  });\n}\n\nfunction readProviderConfig(\n  id: string,\n  config: Config,\n): GithubEntityProviderConfig {\n  const organization = config.getOptionalString('organization');\n  const app = config.getOptionalNumber('app');\n\n  if (!organization && !app) {\n    throw new Error(\n      'Error while processing GitHub provider config. Either organization or app must be specified.',\n    );\n  }\n\n  const catalogPath =\n    config.getOptionalString('catalogPath') ?? DEFAULT_CATALOG_PATH;\n  const host = config.getOptionalString('host') ?? 'github.com';\n  const repositoryPattern = config.getOptionalString('filters.repository');\n  const branchPattern = config.getOptionalString('filters.branch');\n  const allowForks = config.getOptionalBoolean('filters.allowForks') ?? true;\n  const topicFilterInclude = config?.getOptionalStringArray(\n    'filters.topic.include',\n  );\n  const topicFilterExclude = config?.getOptionalStringArray(\n    'filters.topic.exclude',\n  );\n  const allowArchived =\n    config.getOptionalBoolean('filters.allowArchived') ?? false;\n  const validateLocationsExist =\n    config?.getOptionalBoolean('validateLocationsExist') ?? false;\n\n  const catalogPathContainsWildcard = catalogPath.includes('*');\n\n  const visibilityFilterInclude =\n    config?.getOptionalStringArray('filters.visibility');\n\n  if (validateLocationsExist && catalogPathContainsWildcard) {\n    throw Error(\n      `Error while processing GitHub provider config. The catalog path ${catalogPath} contains a wildcard, which is incompatible with validation of locations existing before emitting them. Ensure that validateLocationsExist is set to false.`,\n    );\n  }\n\n  if (branchPattern?.includes('/')) {\n    throw new Error(\n      'Error while processing GitHub provider config. Slash characters (/) are not allowed in filters.branch',\n    );\n  }\n\n  const schedule = config.has('schedule')\n    ? readSchedulerServiceTaskScheduleDefinitionFromConfig(\n        config.getConfig('schedule'),\n      )\n    : DEFAULT_GITHUB_ENTITY_PROVIDER_CONFIG_SCHEDULE;\n\n  const pageSizes = config.has('pageSizes')\n    ? {\n        repositories: config.getOptionalNumber('pageSizes.repositories'),\n      }\n    : undefined;\n\n  return {\n    id,\n    catalogPath,\n    organization,\n    app,\n    host,\n    filters: {\n      repository: repositoryPattern\n        ? compileRegExp(repositoryPattern)\n        : undefined,\n      branch: branchPattern || undefined,\n      allowForks: allowForks,\n      topic: {\n        include: topicFilterInclude,\n        exclude: topicFilterExclude,\n      },\n      visibility: visibilityFilterInclude,\n      allowArchived,\n    },\n    schedule,\n    validateLocationsExist,\n    pageSizes,\n  };\n}\n\n/**\n * Compiles a RegExp while enforcing the pattern to contain\n * the start-of-line and end-of-line anchors.\n *\n * @param pattern\n */\nfunction compileRegExp(pattern: string): RegExp {\n  let fullLinePattern = pattern;\n  if (!fullLinePattern.startsWith('^')) {\n    fullLinePattern = `^${fullLinePattern}`;\n  }\n  if (!fullLinePattern.endsWith('$')) {\n    fullLinePattern = `${fullLinePattern}$`;\n  }\n\n  return new RegExp(fullLinePattern);\n}\n"],"names":["readSchedulerServiceTaskScheduleDefinitionFromConfig"],"mappings":"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"}