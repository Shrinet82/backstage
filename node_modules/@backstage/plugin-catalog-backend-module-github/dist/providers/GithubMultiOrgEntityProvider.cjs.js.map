{"version":3,"file":"GithubMultiOrgEntityProvider.cjs.js","sources":["../../src/providers/GithubMultiOrgEntityProvider.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  ANNOTATION_LOCATION,\n  ANNOTATION_ORIGIN_LOCATION,\n  DEFAULT_NAMESPACE,\n  Entity,\n  isGroupEntity,\n  isUserEntity,\n  parseEntityRef,\n  stringifyEntityRef,\n} from '@backstage/catalog-model';\nimport { Config } from '@backstage/config';\nimport {\n  DefaultGithubCredentialsProvider,\n  GithubAppCredentialsMux,\n  GithubCredentialsProvider,\n  GithubIntegrationConfig,\n  ScmIntegrations,\n} from '@backstage/integration';\nimport {\n  DeferredEntity,\n  EntityProvider,\n  EntityProviderConnection,\n} from '@backstage/plugin-catalog-node';\nimport { EventParams, EventsService } from '@backstage/plugin-events-node';\nimport { graphql } from '@octokit/graphql';\nimport {\n  InstallationCreatedEvent,\n  InstallationEvent,\n  MembershipEvent,\n  OrganizationEvent,\n  OrganizationMemberAddedEvent,\n  OrganizationMemberRemovedEvent,\n  TeamCreatedEvent,\n  TeamDeletedEvent,\n  TeamEditedEvent,\n  TeamEvent,\n} from '@octokit/webhooks-types';\nimport { merge } from 'lodash';\nimport * as uuid from 'uuid';\n\nimport {\n  assignGroupsToUsers,\n  buildOrgHierarchy,\n  defaultOrganizationTeamTransformer,\n  defaultUserTransformer,\n  getOrganizationTeams,\n  assignGroupsToUser,\n  getOrganizationUsers,\n  GithubTeam,\n  TeamTransformer,\n  TransformerContext,\n  UserTransformer,\n  GithubPageSizes,\n  DEFAULT_PAGE_SIZES,\n} from '../lib';\nimport {\n  ANNOTATION_GITHUB_TEAM_SLUG,\n  ANNOTATION_GITHUB_USER_LOGIN,\n} from '../lib/annotation';\nimport {\n  getOrganizationsFromUser,\n  getOrganizationTeam,\n  getOrganizationTeamsForUser,\n  getOrganizationTeamsFromUsers,\n} from '../lib/github';\nimport { splitTeamSlug } from '../lib/util';\nimport { areGroupEntities, areUserEntities } from '../lib/guards';\nimport {\n  LoggerService,\n  SchedulerServiceTaskRunner,\n} from '@backstage/backend-plugin-api';\n\nconst EVENT_TOPICS = [\n  'github.installation',\n  'github.membership',\n  'github.organization',\n  'github.team',\n];\n\n/**\n * Options for {@link GithubMultiOrgEntityProvider}.\n *\n * @public\n */\nexport interface GithubMultiOrgEntityProviderOptions {\n  /**\n   * A unique, stable identifier for this provider.\n   *\n   * @example \"production\"\n   */\n  id: string;\n\n  /**\n   * The target that this provider should consume.\n   *\n   * @example \"https://mycompany.github.com\"\n   */\n  githubUrl: string;\n\n  /**\n   * The list of the GitHub orgs to consume. By default, it will consume all accessible\n   * orgs on the given GitHub instance (support for GitHub App integration only).\n   */\n  orgs?: string[];\n\n  /**\n   * Passing the optional EventsService enables event-based delta updates.\n   */\n  events?: EventsService;\n\n  /**\n   * The refresh schedule to use.\n   *\n   * @defaultValue \"manual\"\n   * @remarks\n   *\n   * If you pass in 'manual', you are responsible for calling the `read` method\n   * manually at some interval.\n   *\n   * But more commonly you will pass in the result of\n   * {@link @backstage/backend-plugin-api#SchedulerService.createScheduledTaskRunner}\n   * to enable automatic scheduling of tasks.\n   */\n  schedule?: 'manual' | SchedulerServiceTaskRunner;\n\n  /**\n   * The logger to use.\n   */\n  logger: LoggerService;\n\n  /**\n   * Optionally supply a custom credentials provider, replacing the default one.\n   */\n  githubCredentialsProvider?: GithubCredentialsProvider;\n\n  /**\n   * Use the default namespace for groups. By default, groups will be namespaced according to their GitHub org.\n   *\n   * @remarks\n   *\n   * If set to true, groups with the same name across different orgs will be considered the same group.\n   */\n  alwaysUseDefaultNamespace?: boolean;\n\n  /**\n   * Optionally include a user transformer for transforming from GitHub users to User Entities\n   */\n  userTransformer?: UserTransformer;\n\n  /**\n   * Optionally include a team transformer for transforming from GitHub teams to Group Entities.\n   * By default, groups will be namespaced according to their GitHub org.\n   */\n  teamTransformer?: TeamTransformer;\n\n  /**\n   * Optionally configure page sizes for GitHub GraphQL API queries.\n   * Reduce these values if hitting RESOURCE_LIMITS_EXCEEDED errors.\n   */\n  pageSizes?: Partial<GithubPageSizes>;\n}\n\ntype CreateDeltaOperation = (entities: Entity[]) => {\n  added: DeferredEntity[];\n  removed: DeferredEntity[];\n};\n\n/**\n * Ingests org data (users and groups) from GitHub.\n *\n * @public\n */\nexport class GithubMultiOrgEntityProvider implements EntityProvider {\n  private connection?: EntityProviderConnection;\n  private scheduleFn?: () => Promise<void>;\n\n  static fromConfig(\n    config: Config,\n    options: GithubMultiOrgEntityProviderOptions,\n  ) {\n    const integrations = ScmIntegrations.fromConfig(config);\n    const gitHubConfig = integrations.github.byUrl(options.githubUrl)?.config;\n\n    if (!gitHubConfig) {\n      throw new Error(\n        `There is no GitHub integration that matches ${options.githubUrl}. Please add a configuration entry for it under integrations.github.`,\n      );\n    }\n\n    const logger = options.logger.child({\n      target: options.githubUrl,\n    });\n\n    const provider = new GithubMultiOrgEntityProvider({\n      id: options.id,\n      gitHubConfig,\n      githubCredentialsProvider:\n        options.githubCredentialsProvider ||\n        DefaultGithubCredentialsProvider.fromIntegrations(integrations),\n      githubUrl: new URL(options.githubUrl).origin,\n      logger,\n      orgs: options.orgs,\n      userTransformer: options.userTransformer,\n      teamTransformer: options.teamTransformer,\n      events: options.events,\n      alwaysUseDefaultNamespace: options.alwaysUseDefaultNamespace,\n      pageSizes: options.pageSizes,\n    });\n\n    provider.schedule(options.schedule);\n\n    return provider;\n  }\n\n  constructor(\n    private readonly options: {\n      events?: EventsService;\n      id: string;\n      gitHubConfig: GithubIntegrationConfig;\n      githubCredentialsProvider: GithubCredentialsProvider;\n      githubUrl: string;\n      logger: LoggerService;\n      orgs?: string[];\n      userTransformer?: UserTransformer;\n      teamTransformer?: TeamTransformer;\n      alwaysUseDefaultNamespace?: boolean;\n      pageSizes?: Partial<GithubPageSizes>;\n    },\n  ) {}\n\n  /** {@inheritdoc @backstage/plugin-catalog-node#EntityProvider.getProviderName} */\n  getProviderName() {\n    return `GithubMultiOrgEntityProvider:${this.options.id}`;\n  }\n\n  private getPageSizes(): GithubPageSizes {\n    return {\n      ...DEFAULT_PAGE_SIZES,\n      ...this.options.pageSizes,\n    };\n  }\n\n  /** {@inheritdoc @backstage/plugin-catalog-node#EntityProvider.connect} */\n  async connect(connection: EntityProviderConnection) {\n    this.connection = connection;\n    await this.options.events?.subscribe({\n      id: this.getProviderName(),\n      topics: EVENT_TOPICS,\n      onEvent: params => this.onEvent(params),\n    });\n    await this.scheduleFn?.();\n  }\n\n  /**\n   * Runs one single complete ingestion. This is only necessary if you use\n   * manual scheduling.\n   */\n  async read(options?: { logger?: LoggerService }) {\n    if (!this.connection) {\n      throw new Error('Not initialized');\n    }\n\n    const logger = options?.logger ?? this.options.logger;\n    const { markReadComplete } = trackProgress(logger);\n\n    const allUsersMap = new Map();\n    const allTeams: Entity[] = [];\n\n    const orgsToProcess = this.options.orgs?.length\n      ? this.options.orgs\n      : await this.getAllOrgs(this.options.gitHubConfig);\n\n    for (const org of orgsToProcess) {\n      const { headers, type: tokenType } =\n        await this.options.githubCredentialsProvider.getCredentials({\n          url: `${this.options.githubUrl}/${org}`,\n        });\n      const client = graphql.defaults({\n        baseUrl: this.options.gitHubConfig.apiBaseUrl,\n        headers,\n      });\n\n      logger.info(`Reading GitHub users and teams for org: ${org}`);\n\n      const pageSizes = this.getPageSizes();\n\n      const { users } = await getOrganizationUsers(\n        client,\n        org,\n        tokenType,\n        this.options.userTransformer,\n        pageSizes,\n      );\n\n      const { teams } = await getOrganizationTeams(\n        client,\n        org,\n        this.defaultMultiOrgTeamTransformer.bind(this),\n        pageSizes,\n      );\n\n      // Grab current users from `allUsersMap` if they already exist in our\n      // pending users so we can append to their group membership relations\n      const pendingUsers = users.map(u => {\n        const userRef = stringifyEntityRef(u);\n        if (!allUsersMap.has(userRef)) {\n          allUsersMap.set(userRef, u);\n        }\n\n        return allUsersMap.get(userRef);\n      });\n\n      if (areGroupEntities(teams)) {\n        buildOrgHierarchy(teams);\n        if (areUserEntities(pendingUsers)) {\n          assignGroupsToUsers(pendingUsers, teams);\n        }\n      }\n\n      allTeams.push(...teams);\n    }\n\n    const allUsers = Array.from(allUsersMap.values());\n\n    const { markCommitComplete } = markReadComplete({ allUsers, allTeams });\n\n    await this.connection.applyMutation({\n      type: 'full',\n      entities: [...allUsers, ...allTeams].map(entity => ({\n        locationKey: `github-multi-org-provider:${this.options.id}`,\n        entity: withLocations(\n          `https://${this.options.gitHubConfig.host}`,\n          entity,\n        ),\n      })),\n    });\n\n    markCommitComplete();\n  }\n\n  private async onEvent(params: EventParams): Promise<void> {\n    const { logger } = this.options;\n    logger.debug(`Received event from ${params.topic}`);\n\n    const orgs = this.options.orgs?.length\n      ? this.options.orgs\n      : await this.getAllOrgs(this.options.gitHubConfig);\n\n    const eventPayload = params.eventPayload as\n      | InstallationEvent\n      | OrganizationEvent\n      | MembershipEvent\n      | TeamEvent;\n\n    if (\n      !orgs.includes(\n        (eventPayload as InstallationEvent).installation?.account?.login,\n      ) &&\n      !orgs.includes(\n        (eventPayload as OrganizationEvent | MembershipEvent | TeamEvent)\n          .organization?.login,\n      )\n    ) {\n      return;\n    }\n\n    // https://docs.github.com/webhooks-and-events/webhooks/webhook-events-and-payloads#installation\n    if (\n      params.topic.includes('installation') &&\n      eventPayload.action === 'created'\n    ) {\n      // We can only respond to installation.created events to add new users/groups since a\n      // installation.deleted event won't provide us info on what user/groups we should remove and\n      // we can't query the uninstalled org since we will no longer have access. This will need to be\n      // eventually resolved via occasional full mutation runs by calling read()\n      await this.onInstallationChange(\n        eventPayload as InstallationCreatedEvent,\n        orgs,\n      );\n    }\n\n    // https://docs.github.com/en/developers/webhooks-and-events/webhooks/webhook-events-and-payloads#organization\n    if (\n      params.topic.includes('organization') &&\n      (eventPayload.action === 'member_added' ||\n        eventPayload.action === 'member_removed')\n    ) {\n      await this.onMemberChangeInOrganization(eventPayload, orgs);\n    }\n\n    // https://docs.github.com/en/developers/webhooks-and-events/webhooks/webhook-events-and-payloads#team\n    if (params.topic.includes('team')) {\n      if (\n        eventPayload.action === 'created' ||\n        eventPayload.action === 'deleted'\n      ) {\n        await this.onTeamChangeInOrganization(\n          eventPayload as TeamCreatedEvent | TeamDeletedEvent,\n        );\n      } else if (eventPayload.action === 'edited') {\n        await this.onTeamEditedInOrganization(\n          eventPayload as TeamEditedEvent,\n          orgs,\n        );\n      }\n    }\n\n    // https://docs.github.com/en/developers/webhooks-and-events/webhooks/webhook-events-and-payloads#membership\n    if (params.topic.includes('membership')) {\n      await this.onMembershipChangedInTeam(\n        eventPayload as MembershipEvent,\n        orgs,\n      );\n    }\n\n    return;\n  }\n\n  private async onInstallationChange(\n    event: InstallationCreatedEvent,\n    applicableOrgs: string[],\n  ) {\n    if (!this.connection) {\n      throw new Error('Not initialized');\n    }\n\n    const org = event.installation.account.login;\n    const { headers, type: tokenType } =\n      await this.options.githubCredentialsProvider.getCredentials({\n        url: `${this.options.githubUrl}/${org}`,\n      });\n    const client = graphql.defaults({\n      baseUrl: this.options.gitHubConfig.apiBaseUrl,\n      headers,\n    });\n\n    const pageSizes = this.getPageSizes();\n\n    const { users } = await getOrganizationUsers(\n      client,\n      org,\n      tokenType,\n      this.options.userTransformer,\n      pageSizes,\n    );\n\n    const { teams } = await getOrganizationTeams(\n      client,\n      org,\n      this.defaultMultiOrgTeamTransformer.bind(this),\n      pageSizes,\n    );\n\n    if (users.length) {\n      // Fetch group memberships of users in case they already exist and\n      // have memberships in groups from other applicable orgs\n      for (const userOrg of applicableOrgs) {\n        const { headers: orgHeaders } =\n          await this.options.githubCredentialsProvider.getCredentials({\n            url: `${this.options.githubUrl}/${userOrg}`,\n          });\n        const orgClient = graphql.defaults({\n          baseUrl: this.options.gitHubConfig.apiBaseUrl,\n          headers: orgHeaders,\n        });\n\n        const { teams: userTeams } = await getOrganizationTeamsFromUsers(\n          orgClient,\n          userOrg,\n          users.map(\n            u =>\n              u.metadata.annotations?.[ANNOTATION_GITHUB_USER_LOGIN] ||\n              u.metadata.name,\n          ),\n          this.defaultMultiOrgTeamTransformer.bind(this),\n          pageSizes,\n        );\n\n        if (areGroupEntities(userTeams) && areUserEntities(users)) {\n          assignGroupsToUsers(users, userTeams);\n        }\n      }\n    }\n\n    const { added, removed } = this.createAddEntitiesOperation([\n      ...users,\n      ...teams,\n    ]);\n    await this.connection.applyMutation({\n      type: 'delta',\n      removed,\n      added,\n    });\n  }\n\n  private async onMemberChangeInOrganization(\n    event: OrganizationMemberAddedEvent | OrganizationMemberRemovedEvent,\n    applicableOrgs: string[],\n  ) {\n    if (!this.connection) {\n      throw new Error('Not initialized');\n    }\n\n    const userTransformer =\n      this.options.userTransformer || defaultUserTransformer;\n    const { name, avatar_url: avatarUrl, email, login } = event.membership.user;\n    const org = event.organization.login;\n    const { headers } =\n      await this.options.githubCredentialsProvider.getCredentials({\n        url: `${this.options.githubUrl}/${org}`,\n      });\n    const client = graphql.defaults({\n      baseUrl: this.options.gitHubConfig.apiBaseUrl,\n      headers,\n    });\n\n    const { orgs } = await getOrganizationsFromUser(client, login);\n    const userApplicableOrgs = orgs.filter(o => applicableOrgs.includes(o));\n\n    let updateMemberships: boolean;\n    let createDeltaOperation: CreateDeltaOperation;\n    if (event.action === 'member_removed') {\n      if (userApplicableOrgs.length) {\n        // If the user is still associated with another applicable org then we don't want to remove\n        // them, just update the entity to remove any potential group memberships from the old org\n        createDeltaOperation = this.createAddEntitiesOperation.bind(this);\n        updateMemberships = true;\n      } else {\n        // User is no longer part of any applicable orgs so we can remove it,\n        // no need to take memberships into account\n        createDeltaOperation = this.createRemoveEntitiesOperation.bind(this);\n        updateMemberships = false;\n      }\n    } else {\n      // We're not sure if this user was already added as part of another applicable org\n      // so grab the latest memberships (potentially from teams of other orgs) to ensure\n      // we're not accidentally omitting them\n      createDeltaOperation = this.createAddEntitiesOperation.bind(this);\n      updateMemberships = true;\n    }\n\n    const user = await userTransformer(\n      {\n        name,\n        avatarUrl,\n        login,\n        email: email ?? undefined,\n      },\n      {\n        org,\n        client,\n        query: '',\n      },\n    );\n\n    if (!user) {\n      return;\n    }\n\n    if (updateMemberships) {\n      const pageSizes = this.getPageSizes();\n      for (const userOrg of userApplicableOrgs) {\n        const { headers: orgHeaders } =\n          await this.options.githubCredentialsProvider.getCredentials({\n            url: `${this.options.githubUrl}/${userOrg}`,\n          });\n        const orgClient = graphql.defaults({\n          baseUrl: this.options.gitHubConfig.apiBaseUrl,\n          headers: orgHeaders,\n        });\n\n        const { teams } = await getOrganizationTeamsForUser(\n          orgClient,\n          userOrg,\n          login,\n          this.defaultMultiOrgTeamTransformer.bind(this),\n          pageSizes,\n        );\n\n        if (isUserEntity(user) && areGroupEntities(teams)) {\n          assignGroupsToUser(user, teams);\n        }\n      }\n    }\n\n    const { added, removed } = createDeltaOperation([user]);\n    await this.connection.applyMutation({\n      type: 'delta',\n      removed,\n      added,\n    });\n  }\n\n  private async onTeamChangeInOrganization(\n    event: TeamCreatedEvent | TeamDeletedEvent,\n  ) {\n    if (!this.connection) {\n      throw new Error('Not initialized');\n    }\n\n    const org = event.organization.login;\n    const { headers } =\n      await this.options.githubCredentialsProvider.getCredentials({\n        url: `${this.options.githubUrl}/${org}`,\n      });\n    const client = graphql.defaults({\n      baseUrl: this.options.gitHubConfig.apiBaseUrl,\n      headers,\n    });\n\n    const { name, html_url: url, description, slug } = event.team;\n    const group = (await this.defaultMultiOrgTeamTransformer(\n      {\n        name,\n        slug,\n        editTeamUrl: `${url}/edit`,\n        combinedSlug: `${org}/${slug}`,\n        description: description ?? undefined,\n        parentTeam: event.team?.parent?.slug\n          ? ({ slug: event.team.parent.slug } as GithubTeam)\n          : undefined,\n        // entity will be removed or is new\n        members: [],\n      },\n      {\n        org,\n        client,\n        query: '',\n      },\n    )) as Entity;\n\n    const createDeltaOperation =\n      event.action === 'created'\n        ? this.createAddEntitiesOperation.bind(this)\n        : this.createRemoveEntitiesOperation.bind(this);\n    const { added, removed } = createDeltaOperation([group]);\n\n    await this.connection.applyMutation({\n      type: 'delta',\n      removed,\n      added,\n    });\n  }\n\n  private async onTeamEditedInOrganization(\n    event: TeamEditedEvent,\n    applicableOrgs: string[],\n  ) {\n    if (!this.connection) {\n      throw new Error('Not initialized');\n    }\n\n    const org = event.organization.login;\n    const { headers, type: tokenType } =\n      await this.options.githubCredentialsProvider.getCredentials({\n        url: `${this.options.githubUrl}/${org}`,\n      });\n    const client = graphql.defaults({\n      baseUrl: this.options.gitHubConfig.apiBaseUrl,\n      headers,\n    });\n\n    const pageSizes = this.getPageSizes();\n    const teamSlug = event.team.slug;\n    const { team } = await getOrganizationTeam(\n      client,\n      org,\n      teamSlug,\n      this.defaultMultiOrgTeamTransformer.bind(this),\n      pageSizes,\n    );\n\n    const { users } = await getOrganizationUsers(\n      client,\n      org,\n      tokenType,\n      this.options.userTransformer,\n      pageSizes,\n    );\n\n    const usersFromChangedGroup = isGroupEntity(team)\n      ? team.spec.members?.map(m =>\n          stringifyEntityRef(parseEntityRef(m, { defaultKind: 'user' })),\n        ) || []\n      : [];\n    const usersToRebuild = users.filter(u =>\n      usersFromChangedGroup.includes(stringifyEntityRef(u)),\n    );\n\n    if (usersToRebuild.length) {\n      // Update memberships of associated members of this group in case the group entity ref changed\n      for (const userOrg of applicableOrgs) {\n        const { headers: orgHeaders } =\n          await this.options.githubCredentialsProvider.getCredentials({\n            url: `${this.options.githubUrl}/${userOrg}`,\n          });\n        const orgClient = graphql.defaults({\n          baseUrl: this.options.gitHubConfig.apiBaseUrl,\n          headers: orgHeaders,\n        });\n\n        const { teams } = await getOrganizationTeamsFromUsers(\n          orgClient,\n          userOrg,\n          usersToRebuild.map(\n            u =>\n              u.metadata.annotations?.[ANNOTATION_GITHUB_USER_LOGIN] ||\n              u.metadata.name,\n          ),\n          this.defaultMultiOrgTeamTransformer.bind(this),\n          pageSizes,\n        );\n\n        if (areGroupEntities(teams) && areUserEntities(usersToRebuild)) {\n          assignGroupsToUsers(usersToRebuild, teams);\n        }\n      }\n    }\n\n    const oldName = event.changes.name?.from || '';\n    const oldSlug = oldName.toLowerCase().replaceAll(/\\s/gi, '-');\n    const oldGroup = (await this.defaultMultiOrgTeamTransformer(\n      {\n        name: event.changes.name?.from,\n        slug: oldSlug,\n        combinedSlug: `${org}/${oldSlug}`,\n        description: event.changes.description?.from,\n        parentTeam: event.team?.parent?.slug\n          ? ({ slug: event.team.parent.slug } as GithubTeam)\n          : undefined,\n        // entity will be removed\n        members: [],\n      },\n      {\n        org,\n        client,\n        query: '',\n      },\n    )) as Entity;\n\n    // Remove the old group entity in case the entity ref is now different\n    const { removed } = this.createRemoveEntitiesOperation([oldGroup]);\n    const { added } = this.createAddEntitiesOperation([\n      ...usersToRebuild,\n      team,\n    ]);\n    await this.connection.applyMutation({\n      type: 'delta',\n      removed,\n      added,\n    });\n  }\n\n  private async onMembershipChangedInTeam(\n    event: MembershipEvent,\n    applicableOrgs: string[],\n  ) {\n    if (!this.connection) {\n      throw new Error('Not initialized');\n    }\n\n    // The docs are saying I will receive the slug for the removed event,\n    // but the types don't reflect that,\n    // so I will just check to be sure the slug is there\n    // https://docs.github.com/en/developers/webhooks-and-events/webhooks/webhook-events-and-payloads#membership\n    if (!('slug' in event.team)) {\n      return;\n    }\n\n    const org = event.organization.login;\n    const { headers } =\n      await this.options.githubCredentialsProvider.getCredentials({\n        url: `${this.options.githubUrl}/${org}`,\n      });\n    const client = graphql.defaults({\n      baseUrl: this.options.gitHubConfig.apiBaseUrl,\n      headers,\n    });\n\n    const pageSizes = this.getPageSizes();\n    const teamSlug = event.team.slug;\n    const { team } = await getOrganizationTeam(\n      client,\n      org,\n      teamSlug,\n      this.defaultMultiOrgTeamTransformer.bind(this),\n      pageSizes,\n    );\n\n    const userTransformer =\n      this.options.userTransformer || defaultUserTransformer;\n    const { name, avatar_url: avatarUrl, email, login } = event.member;\n    const user = await userTransformer(\n      {\n        name,\n        avatarUrl,\n        login,\n        email: email ?? undefined,\n      },\n      {\n        org,\n        client,\n        query: '',\n      },\n    );\n\n    const mutationEntities = [team];\n\n    if (user && isUserEntity(user)) {\n      const { orgs } = await getOrganizationsFromUser(client, login);\n      const userApplicableOrgs = orgs.filter(o => applicableOrgs.includes(o));\n      for (const userOrg of userApplicableOrgs) {\n        const { headers: orgHeaders } =\n          await this.options.githubCredentialsProvider.getCredentials({\n            url: `${this.options.githubUrl}/${userOrg}`,\n          });\n        const orgClient = graphql.defaults({\n          baseUrl: this.options.gitHubConfig.apiBaseUrl,\n          headers: orgHeaders,\n        });\n\n        const { teams } = await getOrganizationTeamsForUser(\n          orgClient,\n          userOrg,\n          login,\n          this.defaultMultiOrgTeamTransformer.bind(this),\n          pageSizes,\n        );\n\n        if (areGroupEntities(teams)) {\n          assignGroupsToUser(user, teams);\n        }\n      }\n\n      mutationEntities.push(user);\n    }\n\n    const { added, removed } =\n      this.createAddEntitiesOperation(mutationEntities);\n    await this.connection.applyMutation({\n      type: 'delta',\n      removed,\n      added,\n    });\n  }\n\n  private schedule(schedule: GithubMultiOrgEntityProviderOptions['schedule']) {\n    if (!schedule || schedule === 'manual') {\n      return;\n    }\n\n    this.scheduleFn = async () => {\n      const id = `${this.getProviderName()}:refresh`;\n      await schedule.run({\n        id,\n        fn: async () => {\n          const logger = this.options.logger.child({\n            class: GithubMultiOrgEntityProvider.prototype.constructor.name,\n            taskId: id,\n            taskInstanceId: uuid.v4(),\n          });\n\n          try {\n            await this.read({ logger });\n          } catch (error) {\n            logger.error(\n              `${this.getProviderName()} refresh failed, ${error}`,\n              error,\n            );\n          }\n        },\n      });\n    };\n  }\n\n  private async defaultMultiOrgTeamTransformer(\n    team: GithubTeam,\n    ctx: TransformerContext,\n  ): Promise<Entity | undefined> {\n    if (this.options.teamTransformer) {\n      return await this.options.teamTransformer(team, ctx);\n    }\n\n    const result = await defaultOrganizationTeamTransformer(team, ctx);\n\n    if (result && result.spec) {\n      if (!this.options.alwaysUseDefaultNamespace) {\n        result.metadata.namespace = ctx.org.toLocaleLowerCase('en-US');\n      }\n\n      // Group `spec.members` inherits the namespace of it's group so need to explicitly specify refs here\n      result.spec.members = team.members.map(\n        user => `${DEFAULT_NAMESPACE}/${user.login}`,\n      );\n    }\n\n    return result;\n  }\n\n  // Note: Does not support usage of PATs\n  private async getAllOrgs(\n    gitHubConfig: GithubIntegrationConfig,\n  ): Promise<string[]> {\n    const githubAppMux = new GithubAppCredentialsMux(gitHubConfig);\n    const installs = await githubAppMux.getAllInstallations();\n\n    return installs\n      .map(install =>\n        install.target_type === 'Organization' &&\n        install.account &&\n        'login' in install.account &&\n        install.account.login\n          ? install.account.login\n          : undefined,\n      )\n      .filter(Boolean) as string[];\n  }\n\n  private createAddEntitiesOperation(entities: Entity[]) {\n    return {\n      removed: [],\n      added: entities.map(entity => ({\n        locationKey: `github-multi-org-provider:${this.options.id}`,\n        entity: withLocations(\n          `https://${this.options.gitHubConfig.host}`,\n          entity,\n        ),\n      })),\n    };\n  }\n\n  private createRemoveEntitiesOperation(entities: Entity[]) {\n    return {\n      added: [],\n      removed: entities.map(entity => ({\n        locationKey: `github-multi-org-provider:${this.options.id}`,\n        entity: withLocations(\n          `https://${this.options.gitHubConfig.host}`,\n          entity,\n        ),\n      })),\n    };\n  }\n}\n\n// Helps wrap the timing and logging behaviors\nfunction trackProgress(logger: LoggerService) {\n  let timestamp = Date.now();\n  let summary: string;\n\n  logger.info('Reading GitHub users and groups');\n\n  function markReadComplete(read: {\n    allUsers: unknown[];\n    allTeams: unknown[];\n  }) {\n    summary = `${read.allUsers.length} GitHub users and ${read.allTeams.length} GitHub groups`;\n    const readDuration = ((Date.now() - timestamp) / 1000).toFixed(1);\n    timestamp = Date.now();\n    logger.info(`Read ${summary} in ${readDuration} seconds. Committing...`);\n    return { markCommitComplete };\n  }\n\n  function markCommitComplete() {\n    const commitDuration = ((Date.now() - timestamp) / 1000).toFixed(1);\n    logger.info(`Committed ${summary} in ${commitDuration} seconds.`);\n  }\n\n  return { markReadComplete };\n}\n\n// Makes sure that emitted entities have a proper location\nexport function withLocations(baseUrl: string, entity: Entity): Entity {\n  const login =\n    entity.metadata.annotations?.[ANNOTATION_GITHUB_USER_LOGIN] ||\n    entity.metadata.name;\n\n  let org = entity.metadata.namespace;\n  let team = entity.metadata.name;\n  const slug = entity.metadata.annotations?.[ANNOTATION_GITHUB_TEAM_SLUG];\n  if (slug) {\n    const [slugOrg, slugTeam] = splitTeamSlug(slug);\n    org = slugOrg;\n    team = slugTeam;\n  }\n\n  const location =\n    entity.kind === 'Group'\n      ? `url:${baseUrl}/orgs/${org}/teams/${team}`\n      : `url:${baseUrl}/${login}`;\n  return merge(\n    {\n      metadata: {\n        annotations: {\n          [ANNOTATION_LOCATION]: location,\n          [ANNOTATION_ORIGIN_LOCATION]: location,\n        },\n      },\n    },\n    entity,\n  ) as Entity;\n}\n"],"names":["ScmIntegrations","DefaultGithubCredentialsProvider","DEFAULT_PAGE_SIZES","org","graphql","getOrganizationUsers","getOrganizationTeams","stringifyEntityRef","areGroupEntities","buildOrgHierarchy","areUserEntities","assignGroupsToUsers","getOrganizationTeamsFromUsers","ANNOTATION_GITHUB_USER_LOGIN","defaultUserTransformer","getOrganizationsFromUser","getOrganizationTeamsForUser","isUserEntity","assignGroupsToUser","getOrganizationTeam","isGroupEntity","parseEntityRef","uuid","defaultOrganizationTeamTransformer","DEFAULT_NAMESPACE","GithubAppCredentialsMux","ANNOTATION_GITHUB_TEAM_SLUG","splitTeamSlug","merge","ANNOTATION_LOCATION","ANNOTATION_ORIGIN_LOCATION"],"mappings":"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"}