{"version":3,"file":"GithubLocationAnalyzer.cjs.js","sources":["../../src/analyzers/GithubLocationAnalyzer.ts"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  DefaultGithubCredentialsProvider,\n  GithubCredentialsProvider,\n  ScmIntegrationRegistry,\n  ScmIntegrations,\n} from '@backstage/integration';\nimport { Octokit } from '@octokit/rest';\nimport { isEmpty, trimEnd } from 'lodash';\nimport parseGitUrl from 'git-url-parse';\nimport {\n  AnalyzeOptions,\n  CatalogService,\n  ScmLocationAnalyzer,\n} from '@backstage/plugin-catalog-node';\nimport { Config } from '@backstage/config';\nimport { AuthService } from '@backstage/backend-plugin-api';\nimport { extname } from 'path';\n\n/** @public */\nexport type GithubLocationAnalyzerOptions = {\n  config: Config;\n  auth: AuthService;\n  githubCredentialsProvider?: GithubCredentialsProvider;\n  catalog: CatalogService;\n};\n\n/** @public */\nexport class GithubLocationAnalyzer implements ScmLocationAnalyzer {\n  private readonly catalogClient: CatalogService;\n  private readonly githubCredentialsProvider: GithubCredentialsProvider;\n  private readonly integrations: ScmIntegrationRegistry;\n  private readonly auth: AuthService;\n\n  constructor(options: GithubLocationAnalyzerOptions) {\n    this.catalogClient = options.catalog;\n    this.integrations = ScmIntegrations.fromConfig(options.config);\n    this.githubCredentialsProvider =\n      options.githubCredentialsProvider ||\n      DefaultGithubCredentialsProvider.fromIntegrations(this.integrations);\n\n    this.auth = options.auth;\n  }\n\n  supports(url: string) {\n    const integration = this.integrations.byUrl(url);\n    return integration?.type === 'github';\n  }\n\n  async analyze(options: AnalyzeOptions) {\n    const { url, catalogFilename } = options;\n    const { owner, name: repo } = parseGitUrl(url);\n\n    const catalogFile = catalogFilename || 'catalog-info.yaml';\n    const extension = extname(catalogFile);\n    const extensionQuery = !isEmpty(extension)\n      ? `extension:${extension.replace('.', '')}`\n      : '';\n\n    const query = `filename:${catalogFile} ${extensionQuery} repo:${owner}/${repo}`;\n\n    const integration = this.integrations.github.byUrl(url);\n    if (!integration) {\n      throw new Error('Make sure you have a GitHub integration configured');\n    }\n\n    const { token: githubToken } =\n      await this.githubCredentialsProvider.getCredentials({\n        url,\n      });\n\n    const octokitClient = new Octokit({\n      auth: githubToken,\n      baseUrl: integration.config.apiBaseUrl,\n    });\n\n    const searchResult = await octokitClient.search\n      .code({ q: query })\n      .catch(e => {\n        throw new Error(`Couldn't search repository for metadata file, ${e}`);\n      });\n\n    const exists = searchResult.data.total_count > 0;\n    if (exists) {\n      const repoInformation = await octokitClient.repos\n        .get({ owner, repo })\n        .catch(e => {\n          throw new Error(`Couldn't fetch repo data, ${e}`);\n        });\n      const defaultBranch = repoInformation.data.default_branch;\n\n      const result = await Promise.all(\n        searchResult.data.items\n          .map(i => `${trimEnd(url, '/')}/blob/${defaultBranch}/${i.path}`)\n          .map(async target => {\n            const addLocationResult = await this.catalogClient.addLocation(\n              {\n                type: 'url',\n                target,\n                dryRun: true,\n              },\n              { credentials: await this.auth.getOwnServiceCredentials() },\n            );\n            return addLocationResult.entities.map(e => ({\n              location: { type: 'url', target },\n              isRegistered: !!addLocationResult.exists,\n              entity: e,\n            }));\n          }),\n      );\n\n      return { existing: result.flat() };\n    }\n    return { existing: [] };\n  }\n}\n"],"names":["ScmIntegrations","DefaultGithubCredentialsProvider","parseGitUrl","extname","isEmpty","Octokit","trimEnd"],"mappings":"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"}