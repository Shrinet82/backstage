{"version":3,"file":"github.cjs.js","sources":["../../src/lib/github.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Entity } from '@backstage/catalog-model';\nimport { GithubCredentialType } from '@backstage/integration';\nimport { graphql } from '@octokit/graphql';\nimport {\n  defaultOrganizationTeamTransformer,\n  defaultUserTransformer,\n  TeamTransformer,\n  TransformerContext,\n  UserTransformer,\n} from './defaultTransformers';\nimport { withLocations } from './withLocations';\n\nimport { DeferredEntity } from '@backstage/plugin-catalog-node';\nimport { Octokit } from '@octokit/core';\nimport { LoggerService } from '@backstage/backend-plugin-api';\nimport { throttling } from '@octokit/plugin-throttling';\n\n/**\n * Configuration for GitHub GraphQL API page sizes.\n *\n * @public\n */\nexport type GithubPageSizes = {\n  /**\n   * Number of teams to fetch per page when querying organization teams.\n   * Default: 25\n   */\n  teams: number;\n  /**\n   * Number of team members to fetch per page when querying team members.\n   * Default: 50\n   */\n  teamMembers: number;\n  /**\n   * Number of organization members to fetch per page when querying org members.\n   * Default: 50\n   */\n  organizationMembers: number;\n  /**\n   * Number of repositories to fetch per page when querying repositories.\n   * Default: 25\n   */\n  repositories: number;\n};\n\n/**\n * Default page sizes for GitHub GraphQL API queries.\n * These values are reduced to prevent RESOURCE_LIMITS_EXCEEDED errors with large organizations.\n *\n * @public\n */\nexport const DEFAULT_PAGE_SIZES: GithubPageSizes = {\n  teams: 25,\n  teamMembers: 50,\n  organizationMembers: 50,\n  repositories: 25,\n};\n\n// Graphql types\n\nexport type QueryResponse = {\n  organization?: OrganizationResponse;\n  repositoryOwner?: RepositoryOwnerResponse;\n  user?: UserResponse;\n};\n\ntype RepositoryOwnerResponse = {\n  repositories?: Connection<RepositoryResponse>;\n  repository?: RepositoryResponse;\n};\n\nexport type OrganizationResponse = {\n  membersWithRole?: Connection<GithubUser>;\n  team?: GithubTeamResponse;\n  teams?: Connection<GithubTeamResponse>;\n  repositories?: Connection<RepositoryResponse>;\n};\n\nexport type UserResponse = {\n  organizations?: Connection<GithubOrg>;\n};\n\nexport type PageInfo = {\n  hasNextPage: boolean;\n  endCursor?: string;\n};\n\nexport type GithubOrg = {\n  login: string;\n};\n\n/**\n * Github User\n *\n * @public\n */\nexport type GithubUser = {\n  login: string;\n  bio?: string;\n  avatarUrl?: string;\n  email?: string;\n  name?: string;\n  organizationVerifiedDomainEmails?: string[];\n};\n\n/**\n * Github Team\n *\n * @public\n */\nexport type GithubTeam = {\n  slug: string;\n  combinedSlug: string;\n  name?: string;\n  description?: string;\n  avatarUrl?: string;\n  editTeamUrl?: string;\n  parentTeam?: GithubTeam;\n  members: GithubUser[];\n};\n\nexport type GithubTeamResponse = Omit<GithubTeam, 'members'> & {\n  members: Connection<GithubUser>;\n};\n\nexport type RepositoryResponse = {\n  name: string;\n  url: string;\n  isArchived: boolean;\n  isFork: boolean;\n  repositoryTopics: RepositoryTopics;\n  defaultBranchRef: {\n    name: string;\n  } | null;\n  catalogInfoFile: {\n    __typename: string;\n    id: string;\n    text: string;\n  } | null;\n  visibility: string;\n};\n\ntype RepositoryTopics = {\n  nodes: TopicNodes[];\n};\n\ntype TopicNodes = {\n  topic: {\n    name: string;\n  };\n};\n\nexport type Connection<T> = {\n  pageInfo: PageInfo;\n  nodes: T[];\n};\n\n/**\n * Gets all the users out of a Github organization.\n *\n * Note that the users will not have their memberships filled in.\n *\n * @param client - An octokit graphql client\n * @param org - The slug of the org to read\n * @param tokenType - The type of GitHub credential\n * @param userTransformer - Optional transformer for user entities\n * @param pageSizes - Optional page sizes configuration\n */\nexport async function getOrganizationUsers(\n  client: typeof graphql,\n  org: string,\n  tokenType: GithubCredentialType,\n  userTransformer: UserTransformer = defaultUserTransformer,\n  pageSizes: GithubPageSizes = DEFAULT_PAGE_SIZES,\n): Promise<{ users: Entity[] }> {\n  const query = `\n    query users($org: String!, $email: Boolean!, $cursor: String, $organizationMembersPageSize: Int!) {\n      organization(login: $org) {\n        membersWithRole(first: $organizationMembersPageSize, after: $cursor) {\n          pageInfo { hasNextPage, endCursor }\n          nodes {\n            avatarUrl,\n            bio,\n            email @include(if: $email),\n            login,\n            name,\n            organizationVerifiedDomainEmails(login: $org)\n          }\n        }\n      }\n    }`;\n\n  // There is no user -> teams edge, so we leave the memberships empty for\n  // now and let the team iteration handle it instead\n\n  const users = await queryWithPaging(\n    client,\n    query,\n    org,\n    r => r.organization?.membersWithRole,\n    userTransformer,\n    {\n      org,\n      email: tokenType === 'token',\n      organizationMembersPageSize: pageSizes.organizationMembers,\n    },\n  );\n\n  return { users };\n}\n\n/**\n * Gets all the teams out of a Github organization.\n *\n * Note that the teams will not have any relations apart from parent filled in.\n *\n * @param client - An octokit graphql client\n * @param org - The slug of the org to read\n * @param teamTransformer - Optional transformer for team entities\n * @param pageSizes - Optional page sizes configuration\n */\nexport async function getOrganizationTeams(\n  client: typeof graphql,\n  org: string,\n  teamTransformer: TeamTransformer = defaultOrganizationTeamTransformer,\n  pageSizes: GithubPageSizes = DEFAULT_PAGE_SIZES,\n): Promise<{\n  teams: Entity[];\n}> {\n  const query = `\n    query teams($org: String!, $cursor: String, $teamsPageSize: Int!, $membersPageSize: Int!) {\n      organization(login: $org) {\n        teams(first: $teamsPageSize, after: $cursor) {\n          pageInfo { hasNextPage, endCursor }\n          nodes {\n            slug\n            combinedSlug\n            name\n            description\n            avatarUrl\n            editTeamUrl\n            parentTeam { slug }\n            members(first: $membersPageSize, membership: IMMEDIATE) {\n              pageInfo { hasNextPage }\n              nodes {\n                avatarUrl,\n                bio,\n                email,\n                login,\n                name,\n                organizationVerifiedDomainEmails(login: $org)\n               }\n            }\n          }\n        }\n      }\n    }`;\n\n  const materialisedTeams = async (\n    item: GithubTeamResponse,\n    ctx: TransformerContext,\n  ): Promise<Entity | undefined> => {\n    const memberNames: GithubUser[] = [];\n\n    if (!item.members.pageInfo.hasNextPage) {\n      // We got all the members in one go, run the fast path\n      for (const user of item.members.nodes) {\n        memberNames.push(user);\n      }\n    } else {\n      // There were more immediate members than page size - run the slow\n      // path of fetching them explicitly\n      const { members } = await getTeamMembers(\n        ctx.client,\n        ctx.org,\n        item.slug,\n        pageSizes,\n      );\n      for (const userLogin of members) {\n        memberNames.push(userLogin);\n      }\n    }\n\n    const team: GithubTeam = {\n      ...item,\n      members: memberNames,\n    };\n\n    return await teamTransformer(team, ctx);\n  };\n\n  const teams = await queryWithPaging(\n    client,\n    query,\n    org,\n    r => r.organization?.teams,\n    materialisedTeams,\n    {\n      org,\n      teamsPageSize: pageSizes.teams,\n      membersPageSize: pageSizes.teamMembers,\n    },\n  );\n\n  return { teams };\n}\n\nexport async function getOrganizationTeamsFromUsers(\n  client: typeof graphql,\n  org: string,\n  userLogins: string[],\n  teamTransformer: TeamTransformer = defaultOrganizationTeamTransformer,\n  pageSizes: GithubPageSizes = DEFAULT_PAGE_SIZES,\n): Promise<{\n  teams: Entity[];\n}> {\n  const query = `\n   query teams($org: String!, $cursor: String, $userLogins: [String!] = \"\", $teamsPageSize: Int!, $membersPageSize: Int!) {\n  organization(login: $org) {\n    teams(first: $teamsPageSize, after: $cursor, userLogins: $userLogins) {\n      pageInfo {\n        hasNextPage\n        endCursor\n      }\n      nodes {\n        slug\n        combinedSlug\n        name\n        description\n        avatarUrl\n        editTeamUrl\n        parentTeam {\n          slug\n        }\n        members(first: $membersPageSize, membership: IMMEDIATE) {\n          pageInfo {\n            hasNextPage\n          }\n          nodes {\n            avatarUrl,\n            bio,\n            email,\n            login,\n            name,\n            organizationVerifiedDomainEmails(login: $org)\n          }\n        }\n      }\n    }\n  }\n}`;\n\n  const materialisedTeams = async (\n    item: GithubTeamResponse,\n    ctx: TransformerContext,\n  ): Promise<Entity | undefined> => {\n    const memberNames: GithubUser[] = [];\n\n    if (!item.members.pageInfo.hasNextPage) {\n      // We got all the members in one go, run the fast path\n      for (const user of item.members.nodes) {\n        memberNames.push(user);\n      }\n    } else {\n      // There were more immediate members than page size - run the slow\n      // path of fetching them explicitly\n      const { members } = await getTeamMembers(\n        ctx.client,\n        ctx.org,\n        item.slug,\n        pageSizes,\n      );\n      for (const userLogin of members) {\n        memberNames.push(userLogin);\n      }\n    }\n\n    const team: GithubTeam = {\n      ...item,\n      members: memberNames,\n    };\n\n    return await teamTransformer(team, ctx);\n  };\n\n  const teams = await queryWithPaging(\n    client,\n    query,\n    org,\n    r => r.organization?.teams,\n    materialisedTeams,\n    {\n      org,\n      userLogins,\n      teamsPageSize: pageSizes.teams,\n      membersPageSize: pageSizes.teamMembers,\n    },\n  );\n\n  return { teams };\n}\n\nexport async function getOrganizationTeamsForUser(\n  client: typeof graphql,\n  org: string,\n  userLogin: string,\n  teamTransformer: TeamTransformer,\n  pageSizes: GithubPageSizes = DEFAULT_PAGE_SIZES,\n): Promise<{ teams: Entity[] }> {\n  const query = `\n   query teams($org: String!, $cursor: String, $userLogins: [String!] = \"\", $teamsPageSize: Int!) {\n  organization(login: $org) {\n    teams(first: $teamsPageSize, after: $cursor, userLogins: $userLogins) {\n      pageInfo {\n        hasNextPage\n        endCursor\n      }\n      nodes {\n        slug\n        combinedSlug\n        name\n        description\n        avatarUrl\n        editTeamUrl\n        parentTeam {\n          slug\n        }\n      }\n    }\n  }\n}`;\n\n  const materialisedTeams = async (\n    item: GithubTeamResponse,\n    ctx: TransformerContext,\n  ): Promise<Entity | undefined> => {\n    const team: GithubTeam = {\n      ...item,\n      members: [{ login: userLogin }],\n    };\n\n    return await teamTransformer(team, ctx);\n  };\n\n  const teams = await queryWithPaging(\n    client,\n    query,\n    org,\n    r => r.organization?.teams,\n    materialisedTeams,\n    { org, userLogins: [userLogin], teamsPageSize: pageSizes.teams },\n  );\n\n  return { teams };\n}\n\nexport async function getOrganizationsFromUser(\n  client: typeof graphql,\n  user: string,\n): Promise<{\n  orgs: string[];\n}> {\n  const query = `\n  query orgs($user: String!) {\n    user(login: $user) {\n      organizations(first: 100) {\n        nodes { login }\n        pageInfo { hasNextPage, endCursor }\n      }\n    }\n  }`;\n\n  const orgs = await queryWithPaging(\n    client,\n    query,\n    '',\n    r => r.user?.organizations,\n    async o => o.login,\n    { user },\n  );\n\n  return { orgs };\n}\n\nexport async function getOrganizationTeam(\n  client: typeof graphql,\n  org: string,\n  teamSlug: string,\n  teamTransformer: TeamTransformer = defaultOrganizationTeamTransformer,\n  pageSizes: GithubPageSizes = DEFAULT_PAGE_SIZES,\n): Promise<{\n  team: Entity;\n}> {\n  const query = `\n  query teams($org: String!, $teamSlug: String!, $membersPageSize: Int!) {\n      organization(login: $org) {\n        team(slug:$teamSlug) {\n            slug\n            combinedSlug\n            name\n            description\n            avatarUrl\n            editTeamUrl\n            parentTeam { slug }\n            members(first: $membersPageSize, membership: IMMEDIATE) {\n              pageInfo { hasNextPage }\n              nodes { login }\n            }\n        }\n      }\n    }`;\n\n  const materialisedTeam = async (\n    item: GithubTeamResponse,\n    ctx: TransformerContext,\n  ): Promise<Entity | undefined> => {\n    const memberNames: GithubUser[] = [];\n\n    if (!item.members.pageInfo.hasNextPage) {\n      // We got all the members in one go, run the fast path\n      for (const user of item.members.nodes) {\n        memberNames.push(user);\n      }\n    } else {\n      // There were more immediate members than page size - run the slow\n      // path of fetching them explicitly\n      const { members } = await getTeamMembers(\n        ctx.client,\n        ctx.org,\n        item.slug,\n        pageSizes,\n      );\n      for (const userLogin of members) {\n        memberNames.push(userLogin);\n      }\n    }\n\n    const team: GithubTeam = {\n      ...item,\n      members: memberNames,\n    };\n\n    return await teamTransformer(team, ctx);\n  };\n\n  const response: QueryResponse = await client(query, {\n    org,\n    teamSlug,\n    membersPageSize: pageSizes.teamMembers,\n  });\n\n  if (!response.organization?.team)\n    throw new Error(`Found no match for team ${teamSlug}`);\n\n  const team = await materialisedTeam(response.organization?.team, {\n    query,\n    client,\n    org,\n  });\n\n  if (!team) throw new Error(`Can't transform for team ${teamSlug}`);\n\n  return { team };\n}\n\nexport async function getOrganizationRepositories(\n  client: typeof graphql,\n  org: string,\n  catalogPath: string,\n  pageSizes: GithubPageSizes = DEFAULT_PAGE_SIZES,\n): Promise<{ repositories: RepositoryResponse[] }> {\n  let relativeCatalogPathRef: string;\n  // We must strip the leading slash or the query for objects does not work\n  if (catalogPath.startsWith('/')) {\n    relativeCatalogPathRef = catalogPath.substring(1);\n  } else {\n    relativeCatalogPathRef = catalogPath;\n  }\n  const catalogPathRef = `HEAD:${relativeCatalogPathRef}`;\n  const query = `\n    query repositories($org: String!, $catalogPathRef: String!, $cursor: String, $repositoriesPageSize: Int!) {\n      repositoryOwner(login: $org) {\n        login\n        repositories(first: $repositoriesPageSize, after: $cursor) {\n          nodes {\n            name\n            catalogInfoFile: object(expression: $catalogPathRef) {\n              __typename\n              ... on Blob {\n                id\n                text\n              }\n            }\n            url\n            isArchived\n            isFork\n            visibility\n            repositoryTopics(first: 100) {\n              nodes {\n                ... on RepositoryTopic {\n                  topic {\n                    name\n                  }\n                }\n              }\n            }\n            defaultBranchRef {\n              name\n            }\n          }\n          pageInfo {\n            hasNextPage\n            endCursor\n          }\n        }\n      }\n    }`;\n\n  const repositories = await queryWithPaging(\n    client,\n    query,\n    org,\n    r => r.repositoryOwner?.repositories,\n    async x => x,\n    { org, catalogPathRef, repositoriesPageSize: pageSizes.repositories },\n  );\n\n  return { repositories };\n}\n\nexport async function getOrganizationRepository(\n  client: typeof graphql,\n  org: string,\n  repoName: string,\n  catalogPath: string,\n): Promise<RepositoryResponse | null> {\n  let relativeCatalogPathRef: string;\n  // We must strip the leading slash or the query for objects does not work\n  if (catalogPath.startsWith('/')) {\n    relativeCatalogPathRef = catalogPath.substring(1);\n  } else {\n    relativeCatalogPathRef = catalogPath;\n  }\n  const catalogPathRef = `HEAD:${relativeCatalogPathRef}`;\n  const query = `\n    query repository($org: String!, $repoName: String!, $catalogPathRef: String!) {\n      repositoryOwner(login: $org) {\n        repository(name: $repoName) {\n          name\n          catalogInfoFile: object(expression: $catalogPathRef) {\n            __typename\n            ... on Blob {\n              id\n              text\n            }\n          }\n          url\n          isArchived\n          isFork\n          visibility\n          repositoryTopics(first: 100) {\n            nodes {\n              ... on RepositoryTopic {\n                topic {\n                  name\n                }\n              }\n            }\n          }\n          defaultBranchRef {\n            name\n          }\n        }\n      }\n    }`;\n\n  const response: QueryResponse = await client(query, {\n    org,\n    repoName,\n    catalogPathRef,\n  });\n\n  return response.repositoryOwner?.repository || null;\n}\n\n/**\n * Gets all the users out of a Github organization team.\n *\n * Note that the users will not have their memberships filled in.\n *\n * @param client - An octokit graphql client\n * @param org - The slug of the org to read\n * @param teamSlug - The slug of the team to read\n * @param pageSizes - Optional page sizes configuration\n */\nexport async function getTeamMembers(\n  client: typeof graphql,\n  org: string,\n  teamSlug: string,\n  pageSizes: GithubPageSizes = DEFAULT_PAGE_SIZES,\n): Promise<{ members: GithubUser[] }> {\n  const query = `\n    query members($org: String!, $teamSlug: String!, $cursor: String, $membersPageSize: Int!) {\n      organization(login: $org) {\n        team(slug: $teamSlug) {\n          members(first: $membersPageSize, after: $cursor, membership: IMMEDIATE) {\n            pageInfo { hasNextPage, endCursor }\n            nodes { login }\n          }\n        }\n      }\n    }`;\n\n  const members = await queryWithPaging(\n    client,\n    query,\n    org,\n    r => r.organization?.team?.members,\n    async user => user,\n    { org, teamSlug, membersPageSize: pageSizes.teamMembers },\n  );\n\n  return { members };\n}\n\n//\n// Helpers\n//\n\n/**\n * Assists in repeatedly executing a query with a paged response.\n *\n * Requires that the query accepts a $cursor variable.\n *\n * @param client - The octokit client\n * @param query - The query to execute\n * @param org - The slug of the org to read\n * @param connection - A function that, given the response, picks out the actual\n *                   Connection object that's being iterated\n * @param transformer - A function that, given one of the nodes in the Connection,\n *               returns the model mapped form of it\n * @param variables - The variable values that the query needs, minus the cursor\n */\nexport async function queryWithPaging<\n  GraphqlType,\n  OutputType,\n  Variables extends {},\n  Response = QueryResponse,\n>(\n  client: typeof graphql,\n  query: string,\n  org: string,\n  connection: (response: Response) => Connection<GraphqlType> | undefined,\n  transformer: (\n    item: GraphqlType,\n    ctx: TransformerContext,\n  ) => Promise<OutputType | undefined>,\n  variables: Variables,\n): Promise<OutputType[]> {\n  const result: OutputType[] = [];\n  const sleep = (ms: number) => new Promise(r => setTimeout(r, ms));\n\n  let cursor: string | undefined = undefined;\n  for (let j = 0; j < 1000 /* just for sanity */; ++j) {\n    const response: Response = await client(query, {\n      ...variables,\n      cursor,\n    });\n\n    const conn = connection(response);\n    if (!conn) {\n      throw new Error(`Found no match for ${JSON.stringify(variables)}`);\n    }\n\n    for (const node of conn.nodes) {\n      const transformedNode = await transformer(node, {\n        client,\n        query,\n        org,\n      });\n\n      if (transformedNode) {\n        result.push(transformedNode);\n      }\n    }\n\n    if (!conn.pageInfo.hasNextPage) {\n      break;\n    } else {\n      await sleep(1000);\n      cursor = conn.pageInfo.endCursor;\n    }\n  }\n\n  return result;\n}\n\nexport type DeferredEntitiesBuilder = (\n  org: string,\n  entities: Entity[],\n) => { added: DeferredEntity[]; removed: DeferredEntity[] };\n\nexport const createAddEntitiesOperation =\n  (id: string, host: string) => (org: string, entities: Entity[]) => ({\n    removed: [],\n    added: entities.map(entity => ({\n      locationKey: `github-org-provider:${id}`,\n      entity: withLocations(`https://${host}`, org, entity),\n    })),\n  });\n\nexport const createRemoveEntitiesOperation =\n  (id: string, host: string) => (org: string, entities: Entity[]) => ({\n    added: [],\n    removed: entities.map(entity => ({\n      locationKey: `github-org-provider:${id}`,\n      entity: withLocations(`https://${host}`, org, entity),\n    })),\n  });\n\nexport const createReplaceEntitiesOperation =\n  (id: string, host: string) => (org: string, entities: Entity[]) => {\n    const entitiesToReplace = entities.map(entity => ({\n      locationKey: `github-org-provider:${id}`,\n      entity: withLocations(`https://${host}`, org, entity),\n    }));\n\n    return {\n      removed: entitiesToReplace,\n      added: entitiesToReplace,\n    };\n  };\n\n/**\n * Creates a GraphQL Client with Throttling\n */\nexport const createGraphqlClient = (args: {\n  headers:\n    | {\n        [name: string]: string;\n      }\n    | undefined;\n  baseUrl: string;\n  logger: LoggerService;\n}): typeof graphql => {\n  const { headers, baseUrl, logger } = args;\n  const ThrottledOctokit = Octokit.plugin(throttling);\n  const octokit = new ThrottledOctokit({\n    throttle: {\n      onRateLimit: (retryAfter, rateLimitData, _, retryCount) => {\n        logger.warn(\n          `Request quota exhausted for request ${rateLimitData?.method} ${rateLimitData?.url}`,\n        );\n\n        if (retryCount < 2) {\n          logger.warn(\n            `Retrying after ${retryAfter} seconds for the ${retryCount} time due to Rate Limit!`,\n          );\n          return true;\n        }\n\n        return false;\n      },\n      onSecondaryRateLimit: (retryAfter, rateLimitData, _, retryCount) => {\n        logger.warn(\n          `Secondary Rate Limit Exhausted for request ${rateLimitData?.method} ${rateLimitData?.url}`,\n        );\n\n        if (retryCount < 2) {\n          logger.warn(\n            `Retrying after ${retryAfter} seconds for the ${retryCount} time due to Secondary Rate Limit!`,\n          );\n          return true;\n        }\n\n        return false;\n      },\n    },\n  });\n\n  const client = octokit.graphql.defaults({\n    headers,\n    baseUrl,\n  });\n\n  return client;\n};\n"],"names":["defaultUserTransformer","defaultOrganizationTeamTransformer","team","withLocations","Octokit","throttling"],"mappings":"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"}