{"version":3,"file":"util.cjs.js","sources":["../../src/lib/util.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { GithubTopicFilters } from '../providers/GithubEntityProviderConfig';\n\nexport function parseGithubOrgUrl(urlString: string): { org: string } {\n  const path = new URL(urlString).pathname.slice(1).split('/');\n\n  // /backstage\n  if (path.length === 1 && path[0].length) {\n    return { org: decodeURIComponent(path[0]) };\n  }\n\n  throw new Error(`Expected a URL pointing to /<org>`);\n}\n\nexport function satisfiesTopicFilter(\n  topics: string[],\n  topicFilter: GithubTopicFilters | undefined,\n): Boolean {\n  // We don't want to do anything if a filter is not configured (or configured but empty)\n  if (!topicFilter) return true;\n  if (!topicFilter.include && !topicFilter.exclude) return true;\n  if (!topicFilter.include?.length && !topicFilter.exclude?.length) return true;\n  // If topic.include is in use, a topic MUST be set that matches the inclusion\n  // filter in order for a repository to be ingested\n  if (topicFilter.include?.length && !topicFilter.exclude) {\n    for (const topic of topics) {\n      if (topicFilter.include.includes(topic)) return true;\n    }\n    return false;\n  }\n  // If topic.exclude is in use, all topics are included by default\n  // with anything matching the filter being discarded. It is technically\n  // possible for the filter to be explicitly empty meaning all repositories\n  // are ingested although doing so would be pointless.\n  if (!topicFilter.include && topicFilter.exclude?.length) {\n    if (!topics.length) return true;\n    for (const topic of topics) {\n      if (topicFilter.exclude.includes(topic)) return false;\n    }\n    return true;\n  }\n  // Now the tricky part is where we have both include and exclude configured.\n  // In this case, exclude wins out so we take everything matching the initial\n  // inclusion filter and from that group, we further discard anything matching\n  // the exclusion filter. If an item were to have a topic set in both filters,\n  // we expect it to be discarded in the end. The use case here is that is that\n  // you may want to retrieve all repos with the topic of team-a while excluding\n  // matching repos that are marked as experiments.\n  if (topicFilter.include && topicFilter.exclude) {\n    const matchesInclude = satisfiesTopicFilter(topics, {\n      include: topicFilter.include,\n    });\n    const matchesExclude = !satisfiesTopicFilter(topics, {\n      exclude: topicFilter.exclude,\n    });\n    if (matchesExclude) return false;\n    return matchesInclude;\n  }\n\n  // If the topic filter is somehow ever in a state that is not covered here, we\n  // will fail \"open\" so that Backstage is still usable as if the filter was\n  // not configured at all.\n  return true;\n}\n\nexport function satisfiesForkFilter(\n  allowForks: boolean | true,\n  isFork: boolean | false,\n): Boolean {\n  // we don't want to include forks if forks are not allowed\n  if (!allowForks && isFork) return false;\n\n  // if forks are allowed, allow all repos through\n  return true;\n}\n\n// Given the github organisation team slug, returns a tuple containing [organisation, team]\nexport function splitTeamSlug(slug: string): [string, string] {\n  const parts = slug.split('/');\n  if (parts.length !== 2) {\n    throw new Error(\n      `Github team slug '${slug}' was not in the expected format <organisation>/<team>`,\n    );\n  }\n  return [parts[0], parts[1]];\n}\n\nexport function satisfiesVisibilityFilter(\n  visibilities: string[],\n  visibility: string,\n): Boolean {\n  if (!visibilities.length) {\n    return true;\n  }\n  const lowerCaseVisibilities = visibilities.map(v =>\n    v.toLocaleLowerCase('en-US'),\n  );\n  const lowerCaseVisibility = visibility.toLocaleLowerCase('en-US');\n\n  return lowerCaseVisibilities.includes(lowerCaseVisibility);\n}\n"],"names":[],"mappings":"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"}