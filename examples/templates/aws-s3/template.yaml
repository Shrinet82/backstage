apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: create-aws-s3-bucket
  title: Create AWS S3 Bucket
  description: Provision an S3 bucket via Terraform and GitHub Actions with cost estimation
  tags:
    - aws
    - s3
    - terraform
    - infracost
spec:
  owner: user:guest
  type: infrastructure

  parameters:
    - title: Bucket Configuration
      required:
        - bucketName
        - awsRegion
        - environment
      properties:
        bucketName:
          title: Bucket Name
          type: string
          description: Globally unique name for the S3 bucket (must start with backstage-)
          pattern: ^backstage-.*$
          ui:autofocus: true
        awsRegion:
          title: AWS Region
          type: string
          description: AWS Region to provision in
          default: us-east-1
          enum:
            - us-east-1
            - us-west-2
            - eu-west-1
        environment:
          title: Environment
          type: string
          description: Deployment environment
          default: development
          enum:
            - development
            - staging
            - production
        owner:
          title: Owner
          type: string
          description: Team or individual responsible for this resource
          default: platform-team
        costCenter:
          title: Cost Center
          type: string
          description: Cost allocation identifier for billing
          default: engineering
          enum:
            - engineering
            - data-science
            - infrastructure
            - product

    - title: Terraform Action & Notifications
      properties:
        action:
          title: Terraform Action
          type: string
          description: Action to perform
          default: plan
          enum:
            - plan
            - apply
            - destroy
        enableCostEstimation:
          title: Enable Cost Estimation
          type: boolean
          description: Run Infracost to estimate monthly costs before apply
          default: true
        notifyEmail:
          title: Notification Email (Optional)
          type: string
          description: Email address to notify on completion
          default: ''
          pattern: ^$|^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$
        confirmDestroy:
          title: I confirm I want to DESTROY this resource
          type: boolean
          description: Required confirmation for destroy action
          default: false
          ui:widget: checkbox

  steps:
    - id: validate-destroy
      name: Validate Destroy Confirmation
      action: debug:log
      if: ${{ parameters.action === 'destroy' and parameters.confirmDestroy !== true }}
      input:
        message: '⚠️ DESTROY action requires confirmation checkbox. Aborting.'

    - id: log-inputs
      name: Log Inputs
      action: debug:log
      input:
        message: "Triggering Terraform for bucket '${{ parameters.bucketName }}' in '${{ parameters.awsRegion }}' (${{ parameters.environment }}) - Action: ${{ parameters.action }} | Cost Estimation: ${{ parameters.enableCostEstimation }} | Email: ${{ parameters.notifyEmail }}"

    - id: trigger-workflow
      name: Trigger GitHub Action
      action: github:actions:dispatch
      if: ${{ parameters.action !== 'destroy' or parameters.confirmDestroy === true }}
      input:
        workflowId: terraform-aws-deploy.yml
        repoUrl: github.com?repo=backstage-infra&owner=Shrinet82
        branchOrTagName: main
        workflowInputs:
          bucket_name: ${{ parameters.bucketName }}
          aws_region: ${{ parameters.awsRegion }}
          environment: ${{ parameters.environment }}
          owner: ${{ parameters.owner }}
          cost_center: ${{ parameters.costCenter }}
          action: ${{ parameters.action }}
          enable_cost_estimation: '${{ parameters.enableCostEstimation | string }}'
          notify_email: ${{ parameters.notifyEmail }}

  output:
    links:
      - title: Infrastructure Repo
        url: https://github.com/Shrinet82/backstage-infra
      - title: Terraform Run Details
        url: https://github.com/Shrinet82/backstage-infra/actions
      - title: Cost Estimation (Infracost)
        url: https://github.com/Shrinet82/backstage-infra/actions
